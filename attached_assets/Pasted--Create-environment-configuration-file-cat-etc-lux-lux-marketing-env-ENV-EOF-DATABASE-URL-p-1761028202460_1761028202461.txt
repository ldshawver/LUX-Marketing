# Create environment configuration file
cat > /etc/lux/lux-marketing.env << 'ENV_EOF'
DATABASE_URL=postgresql://luxuser:LuxPass2024!@localhost/lux_marketing
SESSION_SECRET=lux-secret-key-change-this-in-production
FLASK_ENV=production
OPENAI_API_KEY=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
MS_CLIENT_ID=
MS_CLIENT_SECRET=
MS_TENANT_ID=
ENV_EOF

# Secure the environment file
chmod 640 /etc/lux/lux-marketing.env
chown root:luxapp /etc/lux/lux-marketing.env

echo "✓ Environment file created"

# Install dependencies if not already done
cd /var/www/lux-marketing
sudo -u luxapp bash << 'INSTALL_EOF'
source venv/bin/activate
pip install -r requirements.txt 2>&1 | tail -20
echo "✓ Dependencies installed"
INSTALL_EOF

echo "=== Phase 4 & 5 Complete ==="
✓ Environment file created
Requirement already satisfied: jiter<1,>=0.10.0 in ./venv/lib/python3.11/site-packages (from openai->-r requirements.txt (line 11)) (0.11.1)
Requirement already satisfied: pydantic<3,>=1.9.0 in ./venv/lib/python3.11/site-packages (from openai->-r requirements.txt (line 11)) (2.12.3)
Requirement already satisfied: sniffio in ./venv/lib/python3.11/site-packages (from openai->-r requirements.txt (line 11)) (1.3.1)
Requirement already satisfied: tqdm>4 in ./venv/lib/python3.11/site-packages (from openai->-r requirements.txt (line 11)) (4.67.1)
Requirement already satisfied: httpcore==1.* in ./venv/lib/python3.11/site-packages (from httpx<1,>=0.23.0->openai->-r requirements.txt (line 11)) (1.0.9)
Requirement already satisfied: h11>=0.16 in ./venv/lib/python3.11/site-packages (from httpcore==1.*->httpx<1,>=0.23.0->openai->-r requirements.txt (line 11)) (0.16.0)
Requirement already satisfied: annotated-types>=0.6.0 in ./venv/lib/python3.11/site-packages (from pydantic<3,>=1.9.0->openai->-r requirements.txt (line 11)) (0.7.0)
Requirement already satisfied: pydantic-core==2.41.4 in ./venv/lib/python3.11/site-packages (from pydantic<3,>=1.9.0->openai->-r requirements.txt (line 11)) (2.41.4)
Requirement already satisfied: typing-inspection>=0.4.2 in ./venv/lib/python3.11/site-packages (from pydantic<3,>=1.9.0->openai->-r requirements.txt (line 11)) (0.4.2)
Requirement already satisfied: aiohttp>=3.8.4 in ./venv/lib/python3.11/site-packages (from twilio->-r requirements.txt (line 13)) (3.13.1)
Requirement already satisfied: aiohttp-retry>=2.8.3 in ./venv/lib/python3.11/site-packages (from twilio->-r requirements.txt (line 13)) (2.9.1)
Requirement already satisfied: dnspython>=2.0.0 in ./venv/lib/python3.11/site-packages (from email-validator->-r requirements.txt (line 14)) (2.8.0)
Requirement already satisfied: aiohappyeyeballs>=2.5.0 in ./venv/lib/python3.11/site-packages (from aiohttp>=3.8.4->twilio->-r requirements.txt (line 13)) (2.6.1)
Requirement already satisfied: aiosignal>=1.4.0 in ./venv/lib/python3.11/site-packages (from aiohttp>=3.8.4->twilio->-r requirements.txt (line 13)) (1.4.0)
Requirement already satisfied: attrs>=17.3.0 in ./venv/lib/python3.11/site-packages (from aiohttp>=3.8.4->twilio->-r requirements.txt (line 13)) (25.4.0)
Requirement already satisfied: frozenlist>=1.1.1 in ./venv/lib/python3.11/site-packages (from aiohttp>=3.8.4->twilio->-r requirements.txt (line 13)) (1.8.0)
Requirement already satisfied: multidict<7.0,>=4.5 in ./venv/lib/python3.11/site-packages (from aiohttp>=3.8.4->twilio->-r requirements.txt (line 13)) (6.7.0)
Requirement already satisfied: propcache>=0.2.0 in ./venv/lib/python3.11/site-packages (from aiohttp>=3.8.4->twilio->-r requirements.txt (line 13)) (0.4.1)
Requirement already satisfied: yarl<2.0,>=1.17.0 in ./venv/lib/python3.11/site-packages (from aiohttp>=3.8.4->twilio->-r requirements.txt (line 13)) (1.22.0)
Requirement already satisfied: pycparser in ./venv/lib/python3.11/site-packages (from cffi>=2.0.0->cryptography<49,>=2.5->msal->-r requirements.txt (line 9)) (2.23)
✓ Dependencies installed
=== Phase 4 & 5 Complete ===
root@lux:/var/www/lux-marketing# # Drop and recreate the database
sudo -u postgres psql << 'PSQL_EOF'
DROP DATABASE IF EXISTS lux_marketing;
DROP USER IF EXISTS luxuser;
CREATE USER luxuser WITH PASSWORD 'LuxPass2024!';
CREATE DATABASE lux_marketing OWNER luxuser;
GRANT ALL PRIVILEGES ON DATABASE lux_marketing TO luxuser;
PSQL_EOF

echo "✓ Database recreated"

# Create a database initialization script
cat > /var/www/lux-marketing/init_db.py << 'INIT_EOF'
#!/usr/bin/env python3
import os
os.environ['DATABASE_URL'] = 'postgresql://luxuser:LuxPass2024!@localhost/lux_marketing'
os.environ['SESSION_SECRET'] = 'lux-secret-key-change-this-in-production'

from app import app, db
from models import User
from werkzeug.security import generate_password_hash

with app.app_context():
    # Drop all tables and recreate them
    db.drop_all()
    db.create_all()
    
    # Create admin user
    admin = User(
        username='admin',
        email='admin@lux.local',
        password_hash=generate_password_hash('LuxAdmin2024!'),
        is_admin=True
    )
    db.session.add(admin)
    db.session.commit()
    
    print("✓ Database initialized successfully")
    print("✓ Admin user created: admin / LuxAdmin2024!")
INIT_EOF

# Make it executable and run it
chmod +x /var/www/lux-marketing/init_db.py
cd /var/www/lux-marketing
sudo -u luxapp bash << 'RUN_INIT'
source venv/bin/activate
python init_db.py
echo "=== Phase 6 Complete: Database Ready ==="
DROP DATABASE
DROP ROLE
CREATE ROLE
CREATE DATABASE
GRANT
✓ Database recreated
DEBUG:tzlocal:/etc/timezone found, contents:
 Etc/UTC

DEBUG:tzlocal:/etc/localtime found
DEBUG:tzlocal:2 found:
 {'/etc/timezone': 'Etc/UTC', '/etc/localtime is a symlink to': 'Etc/UTC'}
INFO:apscheduler.scheduler:Scheduler started
DEBUG:apscheduler.scheduler:Looking for jobs to run
DEBUG:apscheduler.scheduler:No jobs; waiting until a job is added
INFO:scheduler:Email scheduler initialized
Traceback (most recent call last):
  File "/var/www/lux-marketing/venv/lib/python3.11/site-packages/sqlalchemy/sql/ddl.py", line 1403, in sort_tables_and_constraints
    candidate_sort = list(
                     ^^^^^
  File "/var/www/lux-marketing/venv/lib/python3.11/site-packages/sqlalchemy/util/topological.py", line 73, in sort
    for set_ in sort_as_subsets(tuples, allitems):
  File "/var/www/lux-marketing/venv/lib/python3.11/site-packages/sqlalchemy/util/topological.py", line 47, in sort_as_subsets
    raise CircularDependencyError(
sqlalchemy.exc.CircularDependencyError: Circular dependency detected. (Table('ab_test', MetaData(), Column('id', Integer(), table=<ab_test>, primary_key=True, nullable=False), Column('campaign_id', Integer(), ForeignKey('campaign.id'), table=<ab_test>, nullable=False), Column('test_type', String(length=20), table=<ab_test>, default=ScalarElementColumnDefault('subject_line')), Column('variant_a', Text(), table=<ab_test>), Column('variant_b', Text(), table=<ab_test>), Column('split_ratio', Float(), table=<ab_test>, default=ScalarElementColumnDefault(0.5)), Column('winner', String(length=1), table=<ab_test>), Column('status', String(length=20), table=<ab_test>, default=ScalarElementColumnDefault('draft')), Column('started_at', DateTime(), table=<ab_test>), Column('ended_at', DateTime(), table=<ab_test>), Column('created_at', DateTime(), table=<ab_test>, default=CallableColumnDefault(<function datetime.utcnow at 0x7f8ab21d72e0>)), schema=None), Table('campaign', MetaData(), Column('id', Integer(), table=<campaign>, primary_key=True, nullable=False), Column('name', String(length=120), table=<campaign>, nullable=False), Column('subject', String(length=255), table=<campaign>, nullable=False), Column('template_id', Integer(), ForeignKey('email_template.id'), table=<campaign>), Column('automation_id', Integer(), ForeignKey('automation.id'), table=<campaign>), Column('ab_test_id', Integer(), ForeignKey('ab_test.id'), table=<campaign>), Column('status', String(length=20), table=<campaign>, default=ScalarElementColumnDefault('draft')), Column('scheduled_at', DateTime(), table=<campaign>), Column('sent_at', DateTime(), table=<campaign>), Column('revenue_generated', Float(), table=<campaign>, default=ScalarElementColumnDefault(0.0)), Column('created_at', DateTime(), table=<campaign>, default=CallableColumnDefault(<function datetime.utcnow at 0x7f8ab21834c0>)), Column('updated_at', DateTime(), table=<campaign>, onupdate=CallableColumnDefault(<function datetime.utcnow at 0x7f8ab2183600>), default=CallableColumnDefault(<function datetime.utcnow at 0x7f8ab2183560>)), schema=None))

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/var/www/lux-marketing/venv/lib/python3.11/site-packages/sqlalchemy/sql/ddl.py", line 1087, in visit_metadata
    sort_tables_and_constraints(
  File "/var/www/lux-marketing/venv/lib/python3.11/site-packages/sqlalchemy/sql/ddl.py", line 1434, in sort_tables_and_constraints
    candidate_sort = list(
                     ^^^^^
  File "/var/www/lux-marketing/venv/lib/python3.11/site-packages/sqlalchemy/util/topological.py", line 73, in sort
    for set_ in sort_as_subsets(tuples, allitems):
  File "/var/www/lux-marketing/venv/lib/python3.11/site-packages/sqlalchemy/util/topological.py", line 47, in sort_as_subsets
    raise CircularDependencyError(
sqlalchemy.exc.CircularDependencyError: Circular dependency detected. (Table('ab_test', MetaData(), Column('id', Integer(), table=<ab_test>, primary_key=True, nullable=False), Column('campaign_id', Integer(), ForeignKey('campaign.id'), table=<ab_test>, nullable=False), Column('test_type', String(length=20), table=<ab_test>, default=ScalarElementColumnDefault('subject_line')), Column('variant_a', Text(), table=<ab_test>), Column('variant_b', Text(), table=<ab_test>), Column('split_ratio', Float(), table=<ab_test>, default=ScalarElementColumnDefault(0.5)), Column('winner', String(length=1), table=<ab_test>), Column('status', String(length=20), table=<ab_test>, default=ScalarElementColumnDefault('draft')), Column('started_at', DateTime(), table=<ab_test>), Column('ended_at', DateTime(), table=<ab_test>), Column('created_at', DateTime(), table=<ab_test>, default=CallableColumnDefault(<function datetime.utcnow at 0x7f8ab21d72e0>)), schema=None), Table('campaign', MetaData(), Column('id', Integer(), table=<campaign>, primary_key=True, nullable=False), Column('name', String(length=120), table=<campaign>, nullable=False), Column('subject', String(length=255), table=<campaign>, nullable=False), Column('template_id', Integer(), ForeignKey('email_template.id'), table=<campaign>), Column('automation_id', Integer(), ForeignKey('automation.id'), table=<campaign>), Column('ab_test_id', Integer(), ForeignKey('ab_test.id'), table=<campaign>), Column('status', String(length=20), table=<campaign>, default=ScalarElementColumnDefault('draft')), Column('scheduled_at', DateTime(), table=<campaign>), Column('sent_at', DateTime(), table=<campaign>), Column('revenue_generated', Float(), table=<campaign>, default=ScalarElementColumnDefault(0.0)), Column('created_at', DateTime(), table=<campaign>, default=CallableColumnDefault(<function datetime.utcnow at 0x7f8ab21834c0>)), Column('updated_at', DateTime(), table=<campaign>, onupdate=CallableColumnDefault(<function datetime.utcnow at 0x7f8ab2183600>), default=CallableColumnDefault(<function datetime.utcnow at 0x7f8ab2183560>)), schema=None))

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/var/www/lux-marketing/init_db.py", line 12, in <module>
    db.drop_all()
  File "/var/www/lux-marketing/venv/lib/python3.11/site-packages/flask_sqlalchemy/extension.py", line 917, in drop_all
    self._call_for_binds(bind_key, "drop_all")
  File "/var/www/lux-marketing/venv/lib/python3.11/site-packages/flask_sqlalchemy/extension.py", line 881, in _call_for_binds
    getattr(metadata, op_name)(bind=engine)
  File "/var/www/lux-marketing/venv/lib/python3.11/site-packages/sqlalchemy/sql/schema.py", line 5956, in drop_all
    bind._run_ddl_visitor(
  File "/var/www/lux-marketing/venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 3252, in _run_ddl_visitor
    conn._run_ddl_visitor(visitorcallable, element, **kwargs)
  File "/var/www/lux-marketing/venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 2459, in _run_ddl_visitor
    ).traverse_single(element)
      ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/var/www/lux-marketing/venv/lib/python3.11/site-packages/sqlalchemy/sql/visitors.py", line 661, in traverse_single
    return meth(obj, **kw)
           ^^^^^^^^^^^^^^^
  File "/var/www/lux-marketing/venv/lib/python3.11/site-packages/sqlalchemy/sql/ddl.py", line 1113, in visit_metadata
    raise exc.CircularDependencyError(
sqlalchemy.exc.CircularDependencyError: Can't sort tables for DROP; an unresolvable foreign key dependency exists between tables: ab_test, campaign.  Please ensure that the ForeignKey and ForeignKeyConstraint objects involved in the cycle have names so that they can be dropped using DROP CONSTRAINT.
=== Phase 6 Complete: Database Ready ===
root@lux:/var/www/lux-marketing# # Fix the circular dependency in models.py
cat > models.py << 'MODELS_FIX_EOF'
from datetime import datetime
from app import db
from flask_login import UserMixin
from sqlalchemy import JSON, Text

class User(UserMixin, db.Model):
    id = db.Column(db.Integer, primary_key=True)
    username = db.Column(db.String(64), unique=True, nullable=False)
    email = db.Column(db.String(120), unique=True, nullable=False)
    password_hash = db.Column(db.String(256))
    is_admin = db.Column(db.Boolean, default=False)
    created_at = db.Column(db.DateTime, default=datetime.utcnow)
    
    def __repr__(self):
        return f'<User {self.username}>'

class Contact(db.Model):
    id = db.Column(db.Integer, primary_key=True)
    email = db.Column(db.String(120), nullable=False)
    first_name = db.Column(db.String(64))
    last_name = db.Column(db.String(64))
    company = db.Column(db.String(120))
    phone = db.Column(db.String(20))
    tags = db.Column(db.String(255))
    custom_fields = db.Column(JSON)
    engagement_score = db.Column(db.Float, default=0.0)
    last_activity = db.Column(db.DateTime)
    source = db.Column(db.String(50))
    is_active = db.Column(db.Boolean, default=True)
    created_at = db.Column(db.DateTime, default=datetime.utcnow)
    updated_at = db.Column(db.DateTime, default=datetime.utcnow, onupdate=datetime.utcnow)
    
    campaign_recipients = db.relationship('CampaignRecipient', backref='contact', lazy='dynamic')
    segment_members = db.relationship('SegmentMember', backref='contact', lazy='dynamic')
    
    def __repr__(self):
        return f'<Contact {self.email}>'
    
    @property
    def full_name(self):
        if self.first_name and self.last_name:
            return f"{self.first_name} {self.last_name}"
        return self.first_name or self.last_name or self.email

class EmailTemplate(db.Model):
    id = db.Column(db.Integer, primary_key=True)
echo "=== Phase 6 Complete: Database Ready ==="emoved">'mail_template.id'), nullable=False)all, delete-orphan')')phan')
✓ models.py fixed - circular dependency removed
DEBUG:tzlocal:/etc/timezone found, contents:
 Etc/UTC

DEBUG:tzlocal:/etc/localtime found
DEBUG:tzlocal:2 found:
 {'/etc/timezone': 'Etc/UTC', '/etc/localtime is a symlink to': 'Etc/UTC'}
INFO:apscheduler.scheduler:Scheduler started
DEBUG:apscheduler.scheduler:Looking for jobs to run
INFO:scheduler:Email scheduler initialized
DEBUG:apscheduler.scheduler:No jobs; waiting until a job is added
Traceback (most recent call last):
  File "/var/www/lux-marketing/venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1967, in _exec_single_context
    self.dialect.do_execute(
  File "/var/www/lux-marketing/venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 951, in do_execute
    cursor.execute(statement, parameters)
psycopg2.errors.DependentObjectsStillExist: cannot drop table ab_test because other objects depend on it
DETAIL:  constraint campaign_ab_test_id_fkey on table campaign depends on table ab_test
HINT:  Use DROP ... CASCADE to drop the dependent objects too.


The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/var/www/lux-marketing/init_db.py", line 12, in <module>
    db.drop_all()
  File "/var/www/lux-marketing/venv/lib/python3.11/site-packages/flask_sqlalchemy/extension.py", line 917, in drop_all
    self._call_for_binds(bind_key, "drop_all")
  File "/var/www/lux-marketing/venv/lib/python3.11/site-packages/flask_sqlalchemy/extension.py", line 881, in _call_for_binds
    getattr(metadata, op_name)(bind=engine)
  File "/var/www/lux-marketing/venv/lib/python3.11/site-packages/sqlalchemy/sql/schema.py", line 5956, in drop_all
    bind._run_ddl_visitor(
  File "/var/www/lux-marketing/venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 3252, in _run_ddl_visitor
    conn._run_ddl_visitor(visitorcallable, element, **kwargs)
  File "/var/www/lux-marketing/venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 2459, in _run_ddl_visitor
    ).traverse_single(element)
      ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/var/www/lux-marketing/venv/lib/python3.11/site-packages/sqlalchemy/sql/visitors.py", line 661, in traverse_single
    return meth(obj, **kw)
           ^^^^^^^^^^^^^^^
  File "/var/www/lux-marketing/venv/lib/python3.11/site-packages/sqlalchemy/sql/ddl.py", line 1142, in visit_metadata
    self.traverse_single(
  File "/var/www/lux-marketing/venv/lib/python3.11/site-packages/sqlalchemy/sql/visitors.py", line 661, in traverse_single
    return meth(obj, **kw)
           ^^^^^^^^^^^^^^^
  File "/var/www/lux-marketing/venv/lib/python3.11/site-packages/sqlalchemy/sql/ddl.py", line 1209, in visit_table
    DropTable(table)._invoke_with(self.connection)
  File "/var/www/lux-marketing/venv/lib/python3.11/site-packages/sqlalchemy/sql/ddl.py", line 321, in _invoke_with
    return bind.execute(self)
           ^^^^^^^^^^^^^^^^^^
  File "/var/www/lux-marketing/venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1419, in execute
    return meth(
           ^^^^^
  File "/var/www/lux-marketing/venv/lib/python3.11/site-packages/sqlalchemy/sql/ddl.py", line 187, in _execute_on_connection
    return connection._execute_ddl(
           ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/var/www/lux-marketing/venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1530, in _execute_ddl
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "/var/www/lux-marketing/venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1846, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/var/www/lux-marketing/venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1986, in _exec_single_context
    self._handle_dbapi_exception(
  File "/var/www/lux-marketing/venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 2355, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/var/www/lux-marketing/venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1967, in _exec_single_context
    self.dialect.do_execute(
  File "/var/www/lux-marketing/venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 951, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.InternalError: (psycopg2.errors.DependentObjectsStillExist) cannot drop table ab_test because other objects depend on it
DETAIL:  constraint campaign_ab_test_id_fkey on table campaign depends on table ab_test
HINT:  Use DROP ... CASCADE to drop the dependent objects too.

[SQL: 
DROP TABLE ab_test]
(Background on this error at: https://sqlalche.me/e/20/2j85)
=== Phase 6 Complete: Database Ready ===