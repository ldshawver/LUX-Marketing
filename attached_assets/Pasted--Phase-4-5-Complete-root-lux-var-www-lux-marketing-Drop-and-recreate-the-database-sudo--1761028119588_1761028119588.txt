=== Phase 4 & 5 Complete ===
root@lux:/var/www/lux-marketing# # Drop and recreate the database
sudo -u postgres psql << 'PSQL_EOF'
DROP DATABASE IF EXISTS lux_marketing;
DROP USER IF EXISTS luxuser;
CREATE USER luxuser WITH PASSWORD 'LuxPass2024!';
CREATE DATABASE lux_marketing OWNER luxuser;
GRANT ALL PRIVILEGES ON DATABASE lux_marketing TO luxuser;
PSQL_EOF

echo "✓ Database recreated"

# Create a database initialization script
cat > /var/www/lux-marketing/init_db.py << 'INIT_EOF'
#!/usr/bin/env python3
import os
os.environ['DATABASE_URL'] = 'postgresql://luxuser:LuxPass2024!@localhost/lux_marketing'
os.environ['SESSION_SECRET'] = 'lux-secret-key-change-this-in-production'

from app import app, db
from models import User
from werkzeug.security import generate_password_hash

with app.app_context():
    # Drop all tables and recreate them
    db.drop_all()
    db.create_all()
    
    # Create admin user
    admin = User(
        username='admin',
        email='admin@lux.local',
        password_hash=generate_password_hash('LuxAdmin2024!'),
        is_admin=True
    )
    db.session.add(admin)
    db.session.commit()
    
    print("✓ Database initialized successfully")
    print("✓ Admin user created: admin / LuxAdmin2024!")
INIT_EOF

# Make it executable and run it
chmod +x /var/www/lux-marketing/init_db.py
cd /var/www/lux-marketing
sudo -u luxapp bash << 'RUN_INIT'
source venv/bin/activate
python init_db.py
echo "=== Phase 6 Complete: Database Ready ==="
DROP DATABASE
DROP ROLE
CREATE ROLE
CREATE DATABASE
GRANT
✓ Database recreated
DEBUG:tzlocal:/etc/timezone found, contents:
 Etc/UTC

DEBUG:tzlocal:/etc/localtime found
DEBUG:tzlocal:2 found:
 {'/etc/timezone': 'Etc/UTC', '/etc/localtime is a symlink to': 'Etc/UTC'}
INFO:apscheduler.scheduler:Scheduler started
DEBUG:apscheduler.scheduler:Looking for jobs to run
DEBUG:apscheduler.scheduler:No jobs; waiting until a job is added
INFO:scheduler:Email scheduler initialized
Traceback (most recent call last):
  File "/var/www/lux-marketing/venv/lib/python3.11/site-packages/sqlalchemy/sql/ddl.py", line 1403, in sort_tables_and_constraints
    candidate_sort = list(
                     ^^^^^
  File "/var/www/lux-marketing/venv/lib/python3.11/site-packages/sqlalchemy/util/topological.py", line 73, in sort
    for set_ in sort_as_subsets(tuples, allitems):
  File "/var/www/lux-marketing/venv/lib/python3.11/site-packages/sqlalchemy/util/topological.py", line 47, in sort_as_subsets
    raise CircularDependencyError(
sqlalchemy.exc.CircularDependencyError: Circular dependency detected. (Table('ab_test', MetaData(), Column('id', Integer(), table=<ab_test>, primary_key=True, nullable=False), Column('campaign_id', Integer(), ForeignKey('campaign.id'), table=<ab_test>, nullable=False), Column('test_type', String(length=20), table=<ab_test>, default=ScalarElementColumnDefault('subject_line')), Column('variant_a', Text(), table=<ab_test>), Column('variant_b', Text(), table=<ab_test>), Column('split_ratio', Float(), table=<ab_test>, default=ScalarElementColumnDefault(0.5)), Column('winner', String(length=1), table=<ab_test>), Column('status', String(length=20), table=<ab_test>, default=ScalarElementColumnDefault('draft')), Column('started_at', DateTime(), table=<ab_test>), Column('ended_at', DateTime(), table=<ab_test>), Column('created_at', DateTime(), table=<ab_test>, default=CallableColumnDefault(<function datetime.utcnow at 0x7f8ab21d72e0>)), schema=None), Table('campaign', MetaData(), Column('id', Integer(), table=<campaign>, primary_key=True, nullable=False), Column('name', String(length=120), table=<campaign>, nullable=False), Column('subject', String(length=255), table=<campaign>, nullable=False), Column('template_id', Integer(), ForeignKey('email_template.id'), table=<campaign>), Column('automation_id', Integer(), ForeignKey('automation.id'), table=<campaign>), Column('ab_test_id', Integer(), ForeignKey('ab_test.id'), table=<campaign>), Column('status', String(length=20), table=<campaign>, default=ScalarElementColumnDefault('draft')), Column('scheduled_at', DateTime(), table=<campaign>), Column('sent_at', DateTime(), table=<campaign>), Column('revenue_generated', Float(), table=<campaign>, default=ScalarElementColumnDefault(0.0)), Column('created_at', DateTime(), table=<campaign>, default=CallableColumnDefault(<function datetime.utcnow at 0x7f8ab21834c0>)), Column('updated_at', DateTime(), table=<campaign>, onupdate=CallableColumnDefault(<function datetime.utcnow at 0x7f8ab2183600>), default=CallableColumnDefault(<function datetime.utcnow at 0x7f8ab2183560>)), schema=None))

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/var/www/lux-marketing/venv/lib/python3.11/site-packages/sqlalchemy/sql/ddl.py", line 1087, in visit_metadata
    sort_tables_and_constraints(
  File "/var/www/lux-marketing/venv/lib/python3.11/site-packages/sqlalchemy/sql/ddl.py", line 1434, in sort_tables_and_constraints
    candidate_sort = list(
                     ^^^^^
  File "/var/www/lux-marketing/venv/lib/python3.11/site-packages/sqlalchemy/util/topological.py", line 73, in sort
    for set_ in sort_as_subsets(tuples, allitems):
  File "/var/www/lux-marketing/venv/lib/python3.11/site-packages/sqlalchemy/util/topological.py", line 47, in sort_as_subsets
    raise CircularDependencyError(
sqlalchemy.exc.CircularDependencyError: Circular dependency detected. (Table('ab_test', MetaData(), Column('id', Integer(), table=<ab_test>, primary_key=True, nullable=False), Column('campaign_id', Integer(), ForeignKey('campaign.id'), table=<ab_test>, nullable=False), Column('test_type', String(length=20), table=<ab_test>, default=ScalarElementColumnDefault('subject_line')), Column('variant_a', Text(), table=<ab_test>), Column('variant_b', Text(), table=<ab_test>), Column('split_ratio', Float(), table=<ab_test>, default=ScalarElementColumnDefault(0.5)), Column('winner', String(length=1), table=<ab_test>), Column('status', String(length=20), table=<ab_test>, default=ScalarElementColumnDefault('draft')), Column('started_at', DateTime(), table=<ab_test>), Column('ended_at', DateTime(), table=<ab_test>), Column('created_at', DateTime(), table=<ab_test>, default=CallableColumnDefault(<function datetime.utcnow at 0x7f8ab21d72e0>)), schema=None), Table('campaign', MetaData(), Column('id', Integer(), table=<campaign>, primary_key=True, nullable=False), Column('name', String(length=120), table=<campaign>, nullable=False), Column('subject', String(length=255), table=<campaign>, nullable=False), Column('template_id', Integer(), ForeignKey('email_template.id'), table=<campaign>), Column('automation_id', Integer(), ForeignKey('automation.id'), table=<campaign>), Column('ab_test_id', Integer(), ForeignKey('ab_test.id'), table=<campaign>), Column('status', String(length=20), table=<campaign>, default=ScalarElementColumnDefault('draft')), Column('scheduled_at', DateTime(), table=<campaign>), Column('sent_at', DateTime(), table=<campaign>), Column('revenue_generated', Float(), table=<campaign>, default=ScalarElementColumnDefault(0.0)), Column('created_at', DateTime(), table=<campaign>, default=CallableColumnDefault(<function datetime.utcnow at 0x7f8ab21834c0>)), Column('updated_at', DateTime(), table=<campaign>, onupdate=CallableColumnDefault(<function datetime.utcnow at 0x7f8ab2183600>), default=CallableColumnDefault(<function datetime.utcnow at 0x7f8ab2183560>)), schema=None))

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/var/www/lux-marketing/init_db.py", line 12, in <module>
    db.drop_all()
  File "/var/www/lux-marketing/venv/lib/python3.11/site-packages/flask_sqlalchemy/extension.py", line 917, in drop_all
    self._call_for_binds(bind_key, "drop_all")
  File "/var/www/lux-marketing/venv/lib/python3.11/site-packages/flask_sqlalchemy/extension.py", line 881, in _call_for_binds
    getattr(metadata, op_name)(bind=engine)
  File "/var/www/lux-marketing/venv/lib/python3.11/site-packages/sqlalchemy/sql/schema.py", line 5956, in drop_all
    bind._run_ddl_visitor(
  File "/var/www/lux-marketing/venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 3252, in _run_ddl_visitor
    conn._run_ddl_visitor(visitorcallable, element, **kwargs)
  File "/var/www/lux-marketing/venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 2459, in _run_ddl_visitor
    ).traverse_single(element)
      ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/var/www/lux-marketing/venv/lib/python3.11/site-packages/sqlalchemy/sql/visitors.py", line 661, in traverse_single
    return meth(obj, **kw)
           ^^^^^^^^^^^^^^^
  File "/var/www/lux-marketing/venv/lib/python3.11/site-packages/sqlalchemy/sql/ddl.py", line 1113, in visit_metadata
    raise exc.CircularDependencyError(
sqlalchemy.exc.CircularDependencyError: Can't sort tables for DROP; an unresolvable foreign key dependency exists between tables: ab_test, campaign.  Please ensure that the ForeignKey and ForeignKeyConstraint objects involved in the cycle have names so that they can be dropped using DROP CONSTRAINT.
=== Phase 6 Complete: Database Ready ===