{% extends "base.html" %}

{% block title %}Approval Queue - Admin Dashboard{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2 class="text-white mb-1">Content Approval Queue</h2>
                    <p class="text-muted mb-0">Review and approve all marketing content before publishing</p>
                </div>
                <div class="d-flex gap-2">
                    <button class="btn btn-outline-danger" onclick="emergencyStop()" id="emergencyStopBtn">
                        <i class="fas fa-stop-circle me-2"></i>EMERGENCY STOP
                    </button>
                    <a href="/settings" class="btn btn-outline-secondary">
                        <i class="fas fa-cog me-2"></i>Feature Settings
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card bg-dark border-warning">
                <div class="card-body text-center">
                    <h3 class="text-warning mb-1" id="pendingCount">{{ stats.total_pending or 0 }}</h3>
                    <small class="text-muted">Pending Review</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-dark border-success">
                <div class="card-body text-center">
                    <h3 class="text-success mb-1" id="approvedCount">{{ stats.by_status.approved or 0 }}</h3>
                    <small class="text-muted">Approved</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-dark border-info">
                <div class="card-body text-center">
                    <h3 class="text-info mb-1" id="scheduledCount">{{ stats.by_status.scheduled or 0 }}</h3>
                    <small class="text-muted">Scheduled</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-dark border-danger">
                <div class="card-body text-center">
                    <h3 class="text-danger mb-1" id="rejectedCount">{{ stats.by_status.rejected or 0 }}</h3>
                    <small class="text-muted">Rejected</small>
                </div>
            </div>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-12">
            <div class="card bg-dark">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0 text-white">Filters</h5>
                    <button class="btn btn-sm btn-outline-secondary" onclick="clearFilters()">Clear All</button>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <label class="form-label text-muted">Content Type</label>
                            <select class="form-select bg-dark text-white" id="filterContentType" onchange="applyFilters()">
                                <option value="">All Types</option>
                                <option value="social_post">Social Post</option>
                                <option value="email_campaign">Email Campaign</option>
                                <option value="sms_campaign">SMS Campaign</option>
                                <option value="blog_post">Blog Post</option>
                                <option value="ad_campaign">Ad Campaign</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label text-muted">Creation Mode</label>
                            <select class="form-select bg-dark text-white" id="filterCreationMode" onchange="applyFilters()">
                                <option value="">All Modes</option>
                                <option value="manual">Manual</option>
                                <option value="automated">AI Automated</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label text-muted">Risk Level</label>
                            <select class="form-select bg-dark text-white" id="filterRiskLevel" onchange="applyFilters()">
                                <option value="">All Levels</option>
                                <option value="low">Low</option>
                                <option value="medium">Medium</option>
                                <option value="high">High</option>
                                <option value="critical">Critical</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label text-muted">Platform</label>
                            <select class="form-select bg-dark text-white" id="filterPlatform" onchange="applyFilters()">
                                <option value="">All Platforms</option>
                                <option value="instagram">Instagram</option>
                                <option value="facebook">Facebook</option>
                                <option value="tiktok">TikTok</option>
                                <option value="twitter">X/Twitter</option>
                                <option value="linkedin">LinkedIn</option>
                                <option value="email">Email</option>
                                <option value="sms">SMS</option>
                                <option value="blog">Blog</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-12">
            <div class="card bg-dark">
                <div class="card-header">
                    <h5 class="mb-0 text-white">Pending Approval</h5>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-dark table-hover mb-0">
                            <thead>
                                <tr>
                                    <th>Content</th>
                                    <th>Type</th>
                                    <th>Mode</th>
                                    <th>Platform</th>
                                    <th>Risk</th>
                                    <th>Confidence</th>
                                    <th>Created</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="approvalTableBody">
                                {% if pending_items %}
                                    {% for item in pending_items %}
                                    <tr data-id="{{ item.id }}">
                                        <td>
                                            <div class="d-flex flex-column">
                                                <strong class="text-white">{{ item.title[:50] }}{% if item.title|length > 50 %}...{% endif %}</strong>
                                                <small class="text-muted">{{ item.content_preview[:80] }}{% if item.content_preview|length > 80 %}...{% endif %}</small>
                                            </div>
                                        </td>
                                        <td>
                                            <span class="badge bg-secondary">{{ item.content_type.replace('_', ' ').title() }}</span>
                                        </td>
                                        <td>
                                            {% if item.creation_mode == 'automated' %}
                                                <span class="badge bg-purple"><i class="fas fa-robot me-1"></i>AI</span>
                                            {% else %}
                                                <span class="badge bg-info"><i class="fas fa-user me-1"></i>Manual</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <span class="badge bg-dark border">{{ item.target_platform or 'N/A' }}</span>
                                        </td>
                                        <td>
                                            {% if item.risk_level == 'critical' %}
                                                <span class="badge bg-danger">CRITICAL</span>
                                            {% elif item.risk_level == 'high' %}
                                                <span class="badge bg-warning text-dark">HIGH</span>
                                            {% elif item.risk_level == 'medium' %}
                                                <span class="badge bg-info">MEDIUM</span>
                                            {% else %}
                                                <span class="badge bg-success">LOW</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if item.confidence_score %}
                                                <div class="progress" style="height: 20px; width: 60px;">
                                                    <div class="progress-bar {% if item.confidence_score >= 0.8 %}bg-success{% elif item.confidence_score >= 0.6 %}bg-warning{% else %}bg-danger{% endif %}" 
                                                         style="width: {{ (item.confidence_score * 100)|int }}%">
                                                        {{ (item.confidence_score * 100)|int }}%
                                                    </div>
                                                </div>
                                            {% else %}
                                                <span class="text-muted">N/A</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <small class="text-muted">{{ item.created_at[:10] if item.created_at else 'N/A' }}</small>
                                        </td>
                                        <td>
                                            <div class="btn-group btn-group-sm">
                                                <button class="btn btn-outline-info" onclick="viewItem({{ item.id }})" title="View">
                                                    <i class="fas fa-eye"></i>
                                                </button>
                                                <button class="btn btn-outline-primary" onclick="editItem({{ item.id }})" title="Edit">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                                <button class="btn btn-success" onclick="approveItem({{ item.id }})" title="Approve">
                                                    <i class="fas fa-check"></i>
                                                </button>
                                                <button class="btn btn-danger" onclick="rejectItem({{ item.id }})" title="Reject">
                                                    <i class="fas fa-times"></i>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                {% else %}
                                    <tr>
                                        <td colspan="8" class="text-center py-5">
                                            <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                                            <h5 class="text-muted">No items pending approval</h5>
                                            <p class="text-muted">All content has been reviewed. New items will appear here when created.</p>
                                        </td>
                                    </tr>
                                {% endif %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="viewModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content bg-dark text-white">
            <div class="modal-header border-secondary">
                <h5 class="modal-title" id="viewModalTitle">Content Details</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="viewModalBody">
            </div>
            <div class="modal-footer border-secondary">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="editFromView()">Edit</button>
                <button type="button" class="btn btn-success" onclick="approveFromView()">Approve</button>
                <button type="button" class="btn btn-danger" onclick="rejectFromView()">Reject</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="editModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content bg-dark text-white">
            <div class="modal-header border-secondary">
                <h5 class="modal-title">Edit Content</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="editItemId">
                <div class="mb-3">
                    <label class="form-label">Title</label>
                    <input type="text" class="form-control bg-dark text-white" id="editTitle">
                </div>
                <div class="mb-3">
                    <label class="form-label">Content</label>
                    <textarea class="form-control bg-dark text-white" id="editContent" rows="6"></textarea>
                </div>
                <div class="mb-3">
                    <label class="form-label">Edit Notes</label>
                    <input type="text" class="form-control bg-dark text-white" id="editNotes" placeholder="Describe your changes...">
                </div>
            </div>
            <div class="modal-footer border-secondary">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveEdit()">Save Changes</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="rejectModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content bg-dark text-white">
            <div class="modal-header border-secondary">
                <h5 class="modal-title">Reject Content</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="rejectItemId">
                <div class="mb-3">
                    <label class="form-label">Rejection Reason</label>
                    <textarea class="form-control bg-dark text-white" id="rejectReason" rows="3" placeholder="Explain why this content is being rejected..."></textarea>
                </div>
                <div class="form-check">
                    <input type="checkbox" class="form-check-input" id="requestRegeneration">
                    <label class="form-check-label" for="requestRegeneration">
                        Request AI to regenerate this content
                    </label>
                </div>
            </div>
            <div class="modal-footer border-secondary">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" onclick="confirmReject()">Reject</button>
            </div>
        </div>
    </div>
</div>

<style>
.bg-purple {
    background: linear-gradient(135deg, #6B46C1, #9F7AEA);
}
.card {
    border-radius: 12px;
}
.table-dark {
    --bs-table-bg: transparent;
}
.progress {
    background-color: rgba(255,255,255,0.1);
    border-radius: 10px;
}
.btn-group-sm > .btn {
    padding: 0.25rem 0.5rem;
}
</style>

<script>
let currentViewItem = null;

function applyFilters() {
    const contentType = document.getElementById('filterContentType').value;
    const creationMode = document.getElementById('filterCreationMode').value;
    const riskLevel = document.getElementById('filterRiskLevel').value;
    const platform = document.getElementById('filterPlatform').value;
    
    let url = '/api/approval-queue?';
    if (contentType) url += `content_type=${contentType}&`;
    if (creationMode) url += `creation_mode=${creationMode}&`;
    if (riskLevel) url += `risk_level=${riskLevel}&`;
    
    fetch(url)
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                updateTable(data.items);
                updateStats(data.stats);
            }
        });
}

function clearFilters() {
    document.getElementById('filterContentType').value = '';
    document.getElementById('filterCreationMode').value = '';
    document.getElementById('filterRiskLevel').value = '';
    document.getElementById('filterPlatform').value = '';
    applyFilters();
}

function updateTable(items) {
    const tbody = document.getElementById('approvalTableBody');
    
    if (items.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="8" class="text-center py-5">
                    <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                    <h5 class="text-muted">No items matching filters</h5>
                </td>
            </tr>
        `;
        return;
    }
    
    tbody.innerHTML = items.map(item => `
        <tr data-id="${item.id}">
            <td>
                <div class="d-flex flex-column">
                    <strong class="text-white">${(item.title || '').substring(0, 50)}${(item.title || '').length > 50 ? '...' : ''}</strong>
                    <small class="text-muted">${(item.content_preview || '').substring(0, 80)}...</small>
                </div>
            </td>
            <td><span class="badge bg-secondary">${(item.content_type || '').replace('_', ' ')}</span></td>
            <td>
                ${item.creation_mode === 'automated' 
                    ? '<span class="badge bg-purple"><i class="fas fa-robot me-1"></i>AI</span>'
                    : '<span class="badge bg-info"><i class="fas fa-user me-1"></i>Manual</span>'}
            </td>
            <td><span class="badge bg-dark border">${item.target_platform || 'N/A'}</span></td>
            <td>${getRiskBadge(item.risk_level)}</td>
            <td>${getConfidenceBar(item.confidence_score)}</td>
            <td><small class="text-muted">${item.created_at ? item.created_at.substring(0, 10) : 'N/A'}</small></td>
            <td>
                <div class="btn-group btn-group-sm">
                    <button class="btn btn-outline-info" onclick="viewItem(${item.id})"><i class="fas fa-eye"></i></button>
                    <button class="btn btn-outline-primary" onclick="editItem(${item.id})"><i class="fas fa-edit"></i></button>
                    <button class="btn btn-success" onclick="approveItem(${item.id})"><i class="fas fa-check"></i></button>
                    <button class="btn btn-danger" onclick="rejectItem(${item.id})"><i class="fas fa-times"></i></button>
                </div>
            </td>
        </tr>
    `).join('');
}

function getRiskBadge(level) {
    const badges = {
        'critical': '<span class="badge bg-danger">CRITICAL</span>',
        'high': '<span class="badge bg-warning text-dark">HIGH</span>',
        'medium': '<span class="badge bg-info">MEDIUM</span>',
        'low': '<span class="badge bg-success">LOW</span>'
    };
    return badges[level] || badges['low'];
}

function getConfidenceBar(score) {
    if (!score) return '<span class="text-muted">N/A</span>';
    const pct = Math.round(score * 100);
    const color = pct >= 80 ? 'bg-success' : pct >= 60 ? 'bg-warning' : 'bg-danger';
    return `<div class="progress" style="height:20px;width:60px;"><div class="progress-bar ${color}" style="width:${pct}%">${pct}%</div></div>`;
}

function updateStats(stats) {
    document.getElementById('pendingCount').textContent = stats.total_pending || 0;
    document.getElementById('approvedCount').textContent = stats.by_status?.approved || 0;
    document.getElementById('scheduledCount').textContent = stats.by_status?.scheduled || 0;
    document.getElementById('rejectedCount').textContent = stats.by_status?.rejected || 0;
}

function viewItem(id) {
    fetch(`/api/approval-queue/${id}`)
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                currentViewItem = data.item;
                document.getElementById('viewModalTitle').textContent = data.item.title || 'Content Details';
                
                let html = `
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>Type:</strong> ${data.item.content_type}</p>
                            <p><strong>Mode:</strong> ${data.item.creation_mode}</p>
                            <p><strong>Platform:</strong> ${data.item.target_platform || 'N/A'}</p>
                            <p><strong>Risk Level:</strong> ${data.item.risk_level}</p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>Confidence:</strong> ${data.item.confidence_score ? (data.item.confidence_score * 100).toFixed(0) + '%' : 'N/A'}</p>
                            <p><strong>Created:</strong> ${data.item.created_at}</p>
                            <p><strong>Version:</strong> ${data.item.version}</p>
                        </div>
                    </div>
                    <hr class="border-secondary">
                    <h6>Content</h6>
                    <div class="bg-black p-3 rounded">${data.item.content_preview}</div>
                `;
                
                if (data.item.ai_rationale) {
                    html += `<hr class="border-secondary"><h6>AI Rationale</h6><p class="text-muted">${data.item.ai_rationale}</p>`;
                }
                
                if (data.item.compliance_flags && data.item.compliance_flags.length > 0) {
                    html += `<hr class="border-secondary"><h6 class="text-warning">Compliance Flags</h6><ul>`;
                    data.item.compliance_flags.forEach(flag => {
                        html += `<li class="text-warning">${flag.message}</li>`;
                    });
                    html += '</ul>';
                }
                
                if (data.audit_trail && data.audit_trail.length > 0) {
                    html += `<hr class="border-secondary"><h6>Audit Trail</h6><ul class="list-unstyled">`;
                    data.audit_trail.forEach(log => {
                        html += `<li class="mb-1"><small class="text-muted">${log.created_at}</small> - ${log.action} by ${log.action_by}</li>`;
                    });
                    html += '</ul>';
                }
                
                document.getElementById('viewModalBody').innerHTML = html;
                new bootstrap.Modal(document.getElementById('viewModal')).show();
            }
        });
}

function editItem(id) {
    fetch(`/api/approval-queue/${id}`)
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                document.getElementById('editItemId').value = id;
                document.getElementById('editTitle').value = data.item.title || '';
                document.getElementById('editContent').value = data.item.content_preview || '';
                document.getElementById('editNotes').value = '';
                new bootstrap.Modal(document.getElementById('editModal')).show();
            }
        });
}

function saveEdit() {
    const id = document.getElementById('editItemId').value;
    const content = {
        title: document.getElementById('editTitle').value,
        content: document.getElementById('editContent').value
    };
    const notes = document.getElementById('editNotes').value;
    
    fetch(`/api/approval-queue/${id}/edit`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token() }}'},
        body: JSON.stringify({content, notes})
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            bootstrap.Modal.getInstance(document.getElementById('editModal')).hide();
            applyFilters();
            alert('Content updated successfully!');
        } else {
            alert('Error: ' + (data.error || 'Failed to save'));
        }
    });
}

function approveItem(id) {
    if (!confirm('Approve this content for publishing?')) return;
    
    fetch(`/api/approval-queue/${id}/approve`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token() }}'},
        body: JSON.stringify({})
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            applyFilters();
            alert('Content approved!');
        } else {
            alert('Error: ' + (data.error || 'Failed to approve'));
        }
    });
}

function rejectItem(id) {
    document.getElementById('rejectItemId').value = id;
    document.getElementById('rejectReason').value = '';
    document.getElementById('requestRegeneration').checked = false;
    new bootstrap.Modal(document.getElementById('rejectModal')).show();
}

function confirmReject() {
    const id = document.getElementById('rejectItemId').value;
    const reason = document.getElementById('rejectReason').value;
    const requestRegeneration = document.getElementById('requestRegeneration').checked;
    
    fetch(`/api/approval-queue/${id}/reject`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token() }}'},
        body: JSON.stringify({reason, request_regeneration: requestRegeneration})
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            bootstrap.Modal.getInstance(document.getElementById('rejectModal')).hide();
            applyFilters();
            alert('Content rejected');
        } else {
            alert('Error: ' + (data.error || 'Failed to reject'));
        }
    });
}

function editFromView() {
    if (currentViewItem) {
        bootstrap.Modal.getInstance(document.getElementById('viewModal')).hide();
        editItem(currentViewItem.id);
    }
}

function approveFromView() {
    if (currentViewItem) {
        bootstrap.Modal.getInstance(document.getElementById('viewModal')).hide();
        approveItem(currentViewItem.id);
    }
}

function rejectFromView() {
    if (currentViewItem) {
        bootstrap.Modal.getInstance(document.getElementById('viewModal')).hide();
        rejectItem(currentViewItem.id);
    }
}

function emergencyStop() {
    if (!confirm('EMERGENCY STOP: This will immediately halt ALL automated content creation and publishing. Continue?')) return;
    
    fetch('/api/feature-toggles/emergency-stop', {
        method: 'POST',
        headers: {'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token() }}'}
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            alert('EMERGENCY STOP ACTIVATED - All automation has been halted.');
            document.getElementById('emergencyStopBtn').classList.remove('btn-outline-danger');
            document.getElementById('emergencyStopBtn').classList.add('btn-danger');
            document.getElementById('emergencyStopBtn').innerHTML = '<i class="fas fa-exclamation-triangle me-2"></i>STOPPED';
        }
    });
}
</script>
{% endblock %}
