{% extends "base.html" %}

{% block title %}Automation Trigger Library - LUX Marketing{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row">
        <div class="col-md-12">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <div>
                    <h2><i data-feather="zap"></i> Automation Trigger Library</h2>
                    <p class="text-muted">Pre-built automation templates with detailed workflows. Click to expand and see all steps.</p>
                </div>
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createTriggerModal">
                    <i data-feather="plus"></i> Create Custom Trigger
                </button>
            </div>
        </div>
    </div>

    <!-- Category Filter -->
    <div class="row mt-3">
        <div class="col-md-12">
            <div class="btn-group flex-wrap" role="group">
                <a href="{{ url_for('main.automation_triggers') }}" class="btn btn-outline-secondary {% if not request.args.get('category') %}active{% endif %}">
                    <i data-feather="layers"></i> All
                </a>
                {% for cat in categories %}
                <a href="{{ url_for('main.automation_triggers', category=cat) }}" 
                   class="btn btn-outline-secondary {% if request.args.get('category') == cat %}active{% endif %}">
                    {% if cat == 'ecommerce' %}<i data-feather="shopping-cart"></i>
                    {% elif cat == 'engagement' %}<i data-feather="heart"></i>
                    {% elif cat == 'nurture' %}<i data-feather="users"></i>
                    {% elif cat == 'retention' %}<i data-feather="refresh-cw"></i>
                    {% elif cat == 'sms' %}<i data-feather="smartphone"></i>
                    {% elif cat == 'social' %}<i data-feather="share-2"></i>
                    {% endif %}
                    {{ cat|capitalize }}
                </a>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Stats Row -->
    <div class="row mt-3">
        <div class="col-md-12">
            <div class="d-flex gap-3">
                <span class="badge bg-primary fs-6">{{ triggers|length }} Triggers</span>
                <span class="badge bg-success fs-6">{{ triggers|sum(attribute='usage_count') }} Total Uses</span>
            </div>
        </div>
    </div>

    <!-- Triggers Accordion List -->
    <div class="row mt-4">
        <div class="col-md-12">
            {% if triggers %}
            <div class="accordion" id="triggersAccordion">
                {% for trigger in triggers %}
                <div class="accordion-item mb-3 border" style="border-radius: 8px; overflow: hidden;">
                    <h2 class="accordion-header" id="heading{{ trigger.id }}">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" 
                                data-bs-target="#collapse{{ trigger.id }}" aria-expanded="false" 
                                aria-controls="collapse{{ trigger.id }}"
                                style="background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);">
                            <div class="d-flex justify-content-between align-items-center w-100 me-3">
                                <div class="d-flex align-items-center">
                                    <span class="badge 
                                        {% if trigger.category == 'ecommerce' %}bg-success
                                        {% elif trigger.category == 'engagement' %}bg-primary
                                        {% elif trigger.category == 'nurture' %}bg-info
                                        {% elif trigger.category == 'retention' %}bg-warning
                                        {% elif trigger.category == 'sms' %}bg-danger
                                        {% elif trigger.category == 'social' %}bg-secondary
                                        {% else %}bg-dark{% endif %} me-3">
                                        {{ trigger.category|capitalize }}
                                    </span>
                                    <div>
                                        <strong class="text-white">{{ trigger.name }}</strong>
                                        <small class="text-muted d-block">{{ trigger.trigger_type|replace('_', ' ')|title }}</small>
                                    </div>
                                </div>
                                <div class="d-flex align-items-center gap-2">
                                    <span class="badge bg-dark">{{ trigger.steps_template|length if trigger.steps_template else 0 }} steps</span>
                                    <span class="badge bg-secondary">Used {{ trigger.usage_count }}x</span>
                                </div>
                            </div>
                        </button>
                    </h2>
                    <div id="collapse{{ trigger.id }}" class="accordion-collapse collapse" 
                         aria-labelledby="heading{{ trigger.id }}" data-bs-parent="#triggersAccordion">
                        <div class="accordion-body" style="background: #0d0d1a;">
                            <!-- Description -->
                            <div class="mb-4">
                                <h6 class="text-cyan"><i data-feather="info"></i> Description</h6>
                                <p class="text-white-50">{{ trigger.description }}</p>
                            </div>

                            <!-- Trigger Configuration -->
                            <div class="mb-4">
                                <h6 class="text-cyan"><i data-feather="settings"></i> Trigger Configuration</h6>
                                <div class="row">
                                    {% if trigger.trigger_config %}
                                    {% for key, value in trigger.trigger_config.items() %}
                                    <div class="col-md-4 mb-2">
                                        <div class="p-2 rounded" style="background: rgba(255,255,255,0.05);">
                                            <small class="text-muted">{{ key|replace('_', ' ')|title }}</small>
                                            <div class="text-white">
                                                {% if value is iterable and value is not string %}
                                                    {{ value|join(', ') }}
                                                {% else %}
                                                    {{ value }}
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                    {% endfor %}
                                    {% else %}
                                    <div class="col-md-12">
                                        <span class="text-muted">No configuration specified</span>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>

                            <!-- Automation Steps -->
                            <div class="mb-4">
                                <h6 class="text-cyan"><i data-feather="list"></i> Automation Steps ({{ trigger.steps_template|length if trigger.steps_template else 0 }} total)</h6>
                                <div class="steps-timeline">
                                    {% if trigger.steps_template %}
                                    {% for step in trigger.steps_template %}
                                    <div class="step-item d-flex align-items-start mb-3">
                                        <div class="step-number me-3">
                                            <span class="badge rounded-pill 
                                                {% if step.type == 'email' %}bg-primary
                                                {% elif step.type == 'sms' %}bg-danger
                                                {% elif step.type == 'wait' %}bg-secondary
                                                {% elif step.type == 'social' or step.type == 'social_dm' or step.type == 'social_comment' %}bg-info
                                                {% elif step.type == 'notification' %}bg-warning
                                                {% elif step.type == 'task' %}bg-success
                                                {% elif step.type == 'condition' %}bg-purple
                                                {% else %}bg-dark{% endif %}" 
                                                style="width: 28px; height: 28px; display: flex; align-items: center; justify-content: center;">
                                                {{ loop.index }}
                                            </span>
                                        </div>
                                        <div class="step-content flex-grow-1 p-3 rounded" style="background: rgba(255,255,255,0.05);">
                                            <div class="d-flex justify-content-between align-items-start">
                                                <div>
                                                    <span class="badge 
                                                        {% if step.type == 'email' %}bg-primary
                                                        {% elif step.type == 'sms' %}bg-danger
                                                        {% elif step.type == 'wait' %}bg-secondary
                                                        {% elif step.type == 'social' or step.type == 'social_dm' or step.type == 'social_comment' %}bg-info
                                                        {% elif step.type == 'notification' %}bg-warning
                                                        {% elif step.type == 'task' %}bg-success
                                                        {% elif step.type == 'condition' %}bg-purple
                                                        {% else %}bg-dark{% endif %} mb-2">
                                                        {% if step.type == 'email' %}<i data-feather="mail"></i>
                                                        {% elif step.type == 'sms' %}<i data-feather="smartphone"></i>
                                                        {% elif step.type == 'wait' %}<i data-feather="clock"></i>
                                                        {% elif step.type == 'social' or step.type == 'social_dm' or step.type == 'social_comment' %}<i data-feather="share-2"></i>
                                                        {% elif step.type == 'notification' %}<i data-feather="bell"></i>
                                                        {% elif step.type == 'task' %}<i data-feather="check-square"></i>
                                                        {% elif step.type == 'condition' %}<i data-feather="git-branch"></i>
                                                        {% else %}<i data-feather="box"></i>{% endif %}
                                                        {{ step.type|upper }}
                                                    </span>
                                                    {% if step.template %}
                                                    <strong class="text-white d-block">{{ step.template }}</strong>
                                                    {% endif %}
                                                    {% if step.subject %}
                                                    <small class="text-muted">Subject: {{ step.subject }}</small>
                                                    {% endif %}
                                                    {% if step.message %}
                                                    <small class="text-muted d-block">Message: {{ step.message }}</small>
                                                    {% endif %}
                                                    {% if step.condition %}
                                                    <small class="text-warning">Condition: {{ step.condition }}</small>
                                                    {% endif %}
                                                </div>
                                                <div class="text-end">
                                                    {% if step.delay %}
                                                    <small class="text-muted">
                                                        {% if step.delay == 0 %}
                                                        Immediately
                                                        {% elif step.delay < 0 %}
                                                        {{ (step.delay|abs / 60)|int }} hours before
                                                        {% elif step.delay < 24 %}
                                                        After {{ step.delay }} hours
                                                        {% else %}
                                                        After {{ (step.delay / 24)|int }} days
                                                        {% endif %}
                                                    </small>
                                                    {% endif %}
                                                </div>
                                            </div>
                                            {% if step.description %}
                                            <small class="text-white-50 d-block mt-2">{{ step.description }}</small>
                                            {% endif %}
                                        </div>
                                    </div>
                                    {% endfor %}
                                    {% else %}
                                    <p class="text-muted">No steps configured</p>
                                    {% endif %}
                                </div>
                            </div>

                            <!-- Action Buttons -->
                            <div class="d-flex gap-2 mt-4 pt-3 border-top border-secondary">
                                <a href="{{ url_for('main.create_automation') }}?template={{ trigger.id }}" class="btn btn-primary">
                                    <i data-feather="play"></i> Use This Template
                                </a>
                                <button class="btn btn-outline-info" onclick="duplicateTrigger({{ trigger.id }}, '{{ trigger.name }}')">
                                    <i data-feather="copy"></i> Duplicate
                                </button>
                                <button class="btn btn-outline-warning" onclick="editTrigger({{ trigger.id }})">
                                    <i data-feather="edit"></i> Edit
                                </button>
                                {% if not trigger.is_predefined %}
                                <button class="btn btn-outline-danger" onclick="deleteTrigger({{ trigger.id }}, '{{ trigger.name }}')">
                                    <i data-feather="trash-2"></i> Delete
                                </button>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="card">
                <div class="card-body text-center py-5">
                    <i data-feather="zap" style="width: 64px; height: 64px; color: #6c757d;"></i>
                    <h4 class="mt-3">No Triggers Available</h4>
                    <p class="text-muted">The trigger library will be seeded with templates on first run.</p>
                    <a href="{{ url_for('main.initialize_system') }}" class="btn btn-primary mt-2">
                        <i data-feather="refresh-cw"></i> Initialize System
                    </a>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Create Trigger Modal -->
<div class="modal fade" id="createTriggerModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content" style="background: #1a1a2e;">
            <div class="modal-header border-secondary">
                <h5 class="modal-title"><i data-feather="plus"></i> Create Custom Trigger</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form id="createTriggerForm">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Trigger Name *</label>
                            <input type="text" class="form-control" name="name" required placeholder="My Custom Trigger">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Category *</label>
                            <select class="form-select" name="category" required>
                                <option value="engagement">Engagement</option>
                                <option value="ecommerce">Ecommerce</option>
                                <option value="nurture">Nurture</option>
                                <option value="retention">Retention</option>
                                <option value="sms">SMS</option>
                                <option value="social">Social</option>
                            </select>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Trigger Type *</label>
                            <select class="form-select" name="trigger_type" required>
                                <option value="signup">Signup</option>
                                <option value="form_submit">Form Submit</option>
                                <option value="purchase_complete">Purchase Complete</option>
                                <option value="abandoned_cart">Abandoned Cart</option>
                                <option value="inactive">Inactive User</option>
                                <option value="tag_added">Tag Added</option>
                                <option value="score_threshold">Score Threshold</option>
                                <option value="birthday">Birthday</option>
                                <option value="scheduled_event">Scheduled Event</option>
                                <option value="custom">Custom</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Timing</label>
                            <select class="form-select" name="timing">
                                <option value="immediate">Immediate</option>
                                <option value="delayed">Delayed</option>
                                <option value="scheduled">Scheduled</option>
                            </select>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Description</label>
                        <textarea class="form-control" name="description" rows="3" 
                                  placeholder="Describe what this automation does and when it triggers..."></textarea>
                    </div>
                </div>
                <div class="modal-footer border-secondary">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Create Trigger</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Trigger Modal -->
<div class="modal fade" id="editTriggerModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content" style="background: #1a1a2e;">
            <div class="modal-header border-secondary">
                <h5 class="modal-title"><i data-feather="edit"></i> Edit Trigger</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form id="editTriggerForm">
                <input type="hidden" name="trigger_id" id="editTriggerId">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Trigger Name *</label>
                            <input type="text" class="form-control" name="name" id="editName" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Category *</label>
                            <select class="form-select" name="category" id="editCategory" required>
                                <option value="engagement">Engagement</option>
                                <option value="ecommerce">Ecommerce</option>
                                <option value="nurture">Nurture</option>
                                <option value="retention">Retention</option>
                                <option value="sms">SMS</option>
                                <option value="social">Social</option>
                            </select>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Trigger Type *</label>
                            <select class="form-select" name="trigger_type" id="editTriggerType" required>
                                <option value="signup">Signup</option>
                                <option value="form_submit">Form Submit</option>
                                <option value="purchase_complete">Purchase Complete</option>
                                <option value="abandoned_cart">Abandoned Cart</option>
                                <option value="inactive">Inactive User</option>
                                <option value="tag_added">Tag Added</option>
                                <option value="score_threshold">Score Threshold</option>
                                <option value="birthday">Birthday</option>
                                <option value="scheduled_event">Scheduled Event</option>
                                <option value="custom">Custom</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Timing</label>
                            <select class="form-select" name="timing" id="editTiming">
                                <option value="immediate">Immediate</option>
                                <option value="delayed">Delayed</option>
                                <option value="scheduled">Scheduled</option>
                            </select>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Description</label>
                        <textarea class="form-control" name="description" id="editDescription" rows="3"></textarea>
                    </div>
                </div>
                <div class="modal-footer border-secondary">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Duplicate Trigger Modal -->
<div class="modal fade" id="duplicateTriggerModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content" style="background: #1a1a2e;">
            <div class="modal-header border-secondary">
                <h5 class="modal-title"><i data-feather="copy"></i> Duplicate Trigger</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form id="duplicateTriggerForm">
                <input type="hidden" name="trigger_id" id="duplicateTriggerId">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">New Trigger Name</label>
                        <input type="text" class="form-control" name="new_name" id="duplicateName" 
                               placeholder="Enter name for the copy">
                    </div>
                    <p class="text-muted small">Leave blank to use "{original name} (Copy)"</p>
                </div>
                <div class="modal-footer border-secondary">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-info">Create Copy</button>
                </div>
            </form>
        </div>
    </div>
</div>

<style>
.accordion-button:not(.collapsed) {
    background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%) !important;
    color: white;
}
.accordion-button::after {
    filter: invert(1);
}
.accordion-button:focus {
    box-shadow: none;
    border-color: rgba(108, 99, 255, 0.5);
}
.text-cyan {
    color: #00d4ff;
}
.bg-purple {
    background-color: #9c27b0 !important;
}
.steps-timeline .step-item:not(:last-child)::before {
    content: '';
    position: absolute;
    left: 14px;
    top: 36px;
    width: 2px;
    height: calc(100% - 8px);
    background: rgba(255,255,255,0.1);
}
.steps-timeline .step-item {
    position: relative;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    feather.replace();
    
    // Create trigger form
    document.getElementById('createTriggerForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        const formData = new FormData(this);
        const data = Object.fromEntries(formData);
        
        try {
            const response = await fetch('/api/automation-triggers', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    name: data.name,
                    category: data.category,
                    trigger_type: data.trigger_type,
                    description: data.description,
                    trigger_config: {timing: data.timing}
                })
            });
            
            const result = await response.json();
            if (result.success) {
                location.reload();
            } else {
                alert('Error: ' + result.error);
            }
        } catch (error) {
            alert('Error creating trigger');
        }
    });
    
    // Edit trigger form
    document.getElementById('editTriggerForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        const triggerId = document.getElementById('editTriggerId').value;
        const formData = new FormData(this);
        const data = Object.fromEntries(formData);
        
        try {
            const response = await fetch(`/api/automation-triggers/${triggerId}`, {
                method: 'PATCH',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    name: data.name,
                    category: data.category,
                    trigger_type: data.trigger_type,
                    description: data.description
                })
            });
            
            const result = await response.json();
            if (result.success) {
                location.reload();
            } else {
                alert('Error: ' + result.error);
            }
        } catch (error) {
            alert('Error updating trigger');
        }
    });
    
    // Duplicate trigger form
    document.getElementById('duplicateTriggerForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        const triggerId = document.getElementById('duplicateTriggerId').value;
        const newName = document.getElementById('duplicateName').value;
        
        try {
            const response = await fetch(`/api/automation-triggers/${triggerId}/duplicate`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({new_name: newName || null})
            });
            
            const result = await response.json();
            if (result.success) {
                location.reload();
            } else {
                alert('Error: ' + result.error);
            }
        } catch (error) {
            alert('Error duplicating trigger');
        }
    });
});

function editTrigger(triggerId) {
    fetch(`/api/automation-triggers/${triggerId}`)
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                const trigger = data.trigger;
                document.getElementById('editTriggerId').value = trigger.id;
                document.getElementById('editName').value = trigger.name;
                document.getElementById('editCategory').value = trigger.category;
                document.getElementById('editTriggerType').value = trigger.trigger_type;
                document.getElementById('editDescription').value = trigger.description || '';
                if (trigger.trigger_config && trigger.trigger_config.timing) {
                    document.getElementById('editTiming').value = trigger.trigger_config.timing;
                }
                new bootstrap.Modal(document.getElementById('editTriggerModal')).show();
            }
        });
}

function duplicateTrigger(triggerId, triggerName) {
    document.getElementById('duplicateTriggerId').value = triggerId;
    document.getElementById('duplicateName').value = triggerName + ' (Copy)';
    new bootstrap.Modal(document.getElementById('duplicateTriggerModal')).show();
}

function deleteTrigger(triggerId, triggerName) {
    if (confirm(`Are you sure you want to delete "${triggerName}"? This cannot be undone.`)) {
        fetch(`/api/automation-triggers/${triggerId}`, {method: 'DELETE'})
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                } else {
                    alert('Error: ' + data.error);
                }
            });
    }
}
</script>
{% endblock %}
