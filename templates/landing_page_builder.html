{% extends "base.html" %}
{% block title %}Landing Page Builder - LUX Marketing{% endblock %}

{% block head %}
<style>
.builder-container {
    display: flex;
    height: calc(100vh - 120px);
    gap: 0;
}

.component-panel {
    width: 280px;
    background: #1a1a1a;
    border-right: 1px solid #333;
    overflow-y: auto;
    flex-shrink: 0;
}

.component-panel h6 {
    color: #fff;
    padding: 15px;
    margin: 0;
    background: #222;
    border-bottom: 1px solid #333;
    position: sticky;
    top: 0;
    z-index: 10;
}

.component-category {
    border-bottom: 1px solid #333;
}

.component-category-header {
    padding: 12px 15px;
    cursor: pointer;
    display: flex;
    justify-content: space-between;
    align-items: center;
    color: #aaa;
    font-size: 0.85rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.component-category-header:hover {
    background: #222;
    color: #fff;
}

.component-list {
    padding: 10px;
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 8px;
}

.component-item {
    background: #2a2a2a;
    border: 1px solid #444;
    border-radius: 8px;
    padding: 12px 8px;
    text-align: center;
    cursor: grab;
    transition: all 0.2s;
    color: #ccc;
}

.component-item:hover {
    border-color: #8b5cf6;
    background: #333;
    color: #fff;
    transform: translateY(-2px);
}

.component-item i, .component-item svg {
    display: block;
    margin: 0 auto 6px;
    width: 24px;
    height: 24px;
    color: #8b5cf6;
}

.component-item span {
    font-size: 0.75rem;
    display: block;
}

.canvas-area {
    flex: 1;
    background: #0a0a0a;
    overflow-y: auto;
    padding: 20px;
}

.canvas-wrapper {
    max-width: 1200px;
    margin: 0 auto;
    background: #fff;
    min-height: 800px;
    border-radius: 8px;
    box-shadow: 0 0 40px rgba(0,0,0,0.5);
}

.canvas-content {
    min-height: 400px;
    position: relative;
}

.canvas-content.drag-over {
    background: rgba(139, 92, 246, 0.1);
}

.empty-canvas {
    text-align: center;
    padding: 100px 40px;
    color: #666;
}

.empty-canvas i {
    width: 64px;
    height: 64px;
    margin-bottom: 20px;
    color: #444;
}

.section-block {
    position: relative;
    border: 2px dashed transparent;
    transition: all 0.2s;
}

.section-block:hover {
    border-color: #8b5cf6;
}

.section-block.selected {
    border-color: #8b5cf6;
    border-style: solid;
}

.section-controls {
    position: absolute;
    top: -12px;
    right: 10px;
    display: none;
    gap: 4px;
    z-index: 100;
}

.section-block:hover .section-controls,
.section-block.selected .section-controls {
    display: flex;
}

.section-controls button {
    width: 28px;
    height: 28px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
}

.section-controls .btn-move {
    background: #333;
    color: #fff;
    cursor: grab;
}

.section-controls .btn-edit {
    background: #8b5cf6;
    color: #fff;
}

.section-controls .btn-delete {
    background: #ef4444;
    color: #fff;
}

.properties-panel {
    width: 320px;
    background: #1a1a1a;
    border-left: 1px solid #333;
    overflow-y: auto;
    flex-shrink: 0;
}

.properties-panel h6 {
    color: #fff;
    padding: 15px;
    margin: 0;
    background: #222;
    border-bottom: 1px solid #333;
}

.properties-content {
    padding: 15px;
}

.property-group {
    margin-bottom: 20px;
}

.property-group label {
    display: block;
    color: #aaa;
    font-size: 0.8rem;
    margin-bottom: 6px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.property-group input,
.property-group select,
.property-group textarea {
    width: 100%;
    background: #2a2a2a;
    border: 1px solid #444;
    color: #fff;
    padding: 8px 12px;
    border-radius: 6px;
    font-size: 0.9rem;
}

.property-group input:focus,
.property-group select:focus,
.property-group textarea:focus {
    border-color: #8b5cf6;
    outline: none;
}

.color-picker-row {
    display: flex;
    gap: 8px;
}

.color-picker-row input[type="color"] {
    width: 50px;
    height: 36px;
    padding: 2px;
    cursor: pointer;
}

.color-picker-row input[type="text"] {
    flex: 1;
}

.builder-toolbar {
    background: #1a1a1a;
    padding: 12px 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 1px solid #333;
}

.builder-toolbar-left {
    display: flex;
    align-items: center;
    gap: 15px;
}

.builder-toolbar-right {
    display: flex;
    gap: 10px;
}

.page-name-input {
    background: transparent;
    border: none;
    color: #fff;
    font-size: 1.2rem;
    font-weight: 600;
    width: 300px;
}

.page-name-input:focus {
    outline: none;
    border-bottom: 2px solid #8b5cf6;
}

.device-toggle {
    display: flex;
    background: #2a2a2a;
    border-radius: 6px;
    overflow: hidden;
}

.device-toggle button {
    background: transparent;
    border: none;
    color: #888;
    padding: 8px 12px;
    cursor: pointer;
}

.device-toggle button.active {
    background: #8b5cf6;
    color: #fff;
}

.drop-indicator {
    height: 4px;
    background: #8b5cf6;
    margin: 0;
    display: none;
}

.drop-indicator.active {
    display: block;
}
</style>
{% endblock %}

{% block content %}
<div class="builder-toolbar">
    <div class="builder-toolbar-left">
        <a href="{{ url_for('main.landing_pages') }}" class="btn btn-sm btn-outline-secondary">
            <i data-feather="arrow-left"></i>
        </a>
        <input type="text" class="page-name-input" id="pageName" placeholder="Untitled Landing Page" value="{{ page.name if page else '' }}">
        <input type="text" class="form-control form-control-sm" id="pageSlug" placeholder="url-slug" style="width: 150px; background: #2a2a2a; border-color: #444; color: #fff;" value="{{ page.slug if page else '' }}">
    </div>
    <div class="builder-toolbar-right">
        <div class="device-toggle">
            <button class="active" onclick="setViewport('desktop')" title="Desktop"><i data-feather="monitor"></i></button>
            <button onclick="setViewport('tablet')" title="Tablet"><i data-feather="tablet"></i></button>
            <button onclick="setViewport('mobile')" title="Mobile"><i data-feather="smartphone"></i></button>
        </div>
        <button class="btn btn-outline-info btn-sm" onclick="previewPage()">
            <i data-feather="eye"></i> Preview
        </button>
        <button class="btn btn-outline-primary btn-sm" data-bs-toggle="modal" data-bs-target="#aiSuggestionsModal">
            <i data-feather="cpu"></i> AI Generate
        </button>
        <button class="btn btn-primary btn-sm" onclick="saveLandingPage()">
            <i data-feather="save"></i> Save Page
        </button>
    </div>
</div>

<div class="builder-container">
    <div class="component-panel">
        <h6><i data-feather="layers"></i> Page Sections</h6>
        
        <div class="component-category">
            <div class="component-category-header" onclick="toggleCategory(this)">
                <span>Headers & Heroes</span>
                <i data-feather="chevron-down"></i>
            </div>
            <div class="component-list">
                <div class="component-item" draggable="true" data-section="hero-centered">
                    <i data-feather="square"></i>
                    <span>Hero Centered</span>
                </div>
                <div class="component-item" draggable="true" data-section="hero-split">
                    <i data-feather="columns"></i>
                    <span>Hero Split</span>
                </div>
                <div class="component-item" draggable="true" data-section="hero-video">
                    <i data-feather="play-circle"></i>
                    <span>Hero Video</span>
                </div>
                <div class="component-item" draggable="true" data-section="navbar">
                    <i data-feather="menu"></i>
                    <span>Navigation</span>
                </div>
            </div>
        </div>
        
        <div class="component-category">
            <div class="component-category-header" onclick="toggleCategory(this)">
                <span>Content Sections</span>
                <i data-feather="chevron-down"></i>
            </div>
            <div class="component-list">
                <div class="component-item" draggable="true" data-section="features-grid">
                    <i data-feather="grid"></i>
                    <span>Features Grid</span>
                </div>
                <div class="component-item" draggable="true" data-section="features-list">
                    <i data-feather="list"></i>
                    <span>Features List</span>
                </div>
                <div class="component-item" draggable="true" data-section="text-block">
                    <i data-feather="align-left"></i>
                    <span>Text Block</span>
                </div>
                <div class="component-item" draggable="true" data-section="image-text">
                    <i data-feather="image"></i>
                    <span>Image + Text</span>
                </div>
            </div>
        </div>
        
        <div class="component-category">
            <div class="component-category-header" onclick="toggleCategory(this)">
                <span>Social Proof</span>
                <i data-feather="chevron-down"></i>
            </div>
            <div class="component-list">
                <div class="component-item" draggable="true" data-section="testimonials">
                    <i data-feather="message-circle"></i>
                    <span>Testimonials</span>
                </div>
                <div class="component-item" draggable="true" data-section="logos">
                    <i data-feather="award"></i>
                    <span>Logo Cloud</span>
                </div>
                <div class="component-item" draggable="true" data-section="stats">
                    <i data-feather="bar-chart-2"></i>
                    <span>Stats</span>
                </div>
                <div class="component-item" draggable="true" data-section="reviews">
                    <i data-feather="star"></i>
                    <span>Reviews</span>
                </div>
            </div>
        </div>
        
        <div class="component-category">
            <div class="component-category-header" onclick="toggleCategory(this)">
                <span>Conversion</span>
                <i data-feather="chevron-down"></i>
            </div>
            <div class="component-list">
                <div class="component-item" draggable="true" data-section="cta-banner">
                    <i data-feather="zap"></i>
                    <span>CTA Banner</span>
                </div>
                <div class="component-item" draggable="true" data-section="lead-form">
                    <i data-feather="mail"></i>
                    <span>Lead Form</span>
                </div>
                <div class="component-item" draggable="true" data-section="pricing">
                    <i data-feather="dollar-sign"></i>
                    <span>Pricing Table</span>
                </div>
                <div class="component-item" draggable="true" data-section="countdown">
                    <i data-feather="clock"></i>
                    <span>Countdown</span>
                </div>
            </div>
        </div>
        
        <div class="component-category">
            <div class="component-category-header" onclick="toggleCategory(this)">
                <span>Products & Gallery</span>
                <i data-feather="chevron-down"></i>
            </div>
            <div class="component-list">
                <div class="component-item" draggable="true" data-section="product-grid">
                    <i data-feather="shopping-bag"></i>
                    <span>Product Grid</span>
                </div>
                <div class="component-item" draggable="true" data-section="gallery">
                    <i data-feather="image"></i>
                    <span>Image Gallery</span>
                </div>
                <div class="component-item" draggable="true" data-section="video-embed">
                    <i data-feather="youtube"></i>
                    <span>Video Embed</span>
                </div>
            </div>
        </div>
        
        <div class="component-category">
            <div class="component-category-header" onclick="toggleCategory(this)">
                <span>FAQ & Info</span>
                <i data-feather="chevron-down"></i>
            </div>
            <div class="component-list">
                <div class="component-item" draggable="true" data-section="faq">
                    <i data-feather="help-circle"></i>
                    <span>FAQ</span>
                </div>
                <div class="component-item" draggable="true" data-section="contact">
                    <i data-feather="phone"></i>
                    <span>Contact Info</span>
                </div>
                <div class="component-item" draggable="true" data-section="map">
                    <i data-feather="map-pin"></i>
                    <span>Map</span>
                </div>
            </div>
        </div>
        
        <div class="component-category">
            <div class="component-category-header" onclick="toggleCategory(this)">
                <span>Layout</span>
                <i data-feather="chevron-down"></i>
            </div>
            <div class="component-list">
                <div class="component-item" draggable="true" data-section="spacer">
                    <i data-feather="more-horizontal"></i>
                    <span>Spacer</span>
                </div>
                <div class="component-item" draggable="true" data-section="divider">
                    <i data-feather="minus"></i>
                    <span>Divider</span>
                </div>
                <div class="component-item" draggable="true" data-section="footer">
                    <i data-feather="layout"></i>
                    <span>Footer</span>
                </div>
                <div class="component-item" draggable="true" data-section="html-block">
                    <i data-feather="code"></i>
                    <span>Custom HTML</span>
                </div>
            </div>
        </div>
    </div>
    
    <div class="canvas-area">
        <div class="canvas-wrapper" id="canvasWrapper">
            <div class="canvas-content" id="pageCanvas">
                <div class="empty-canvas" id="emptyState">
                    <i data-feather="layout"></i>
                    <h4>Start Building Your Landing Page</h4>
                    <p>Drag sections from the left panel and drop them here</p>
                </div>
            </div>
        </div>
    </div>
    
    <div class="properties-panel">
        <h6><i data-feather="sliders"></i> Section Properties</h6>
        <div class="properties-content" id="propertiesContent">
            <p class="text-muted text-center mt-4">Select a section to edit its properties</p>
        </div>
    </div>
</div>

<!-- AI Suggestions Modal -->
<div class="modal fade" id="aiSuggestionsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i data-feather="cpu"></i> AI Landing Page Generator</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Describe your landing page:</label>
                    <textarea class="form-control" id="ai-prompt" rows="3" placeholder="e.g., A landing page for a summer sale with 30% discount on all products"></textarea>
                </div>
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label class="form-label">Page Type</label>
                        <select class="form-select" id="ai-page-type">
                            <option value="sales">Sales / Promotion</option>
                            <option value="lead-capture">Lead Capture</option>
                            <option value="event">Event Registration</option>
                            <option value="product">Product Launch</option>
                            <option value="webinar">Webinar Signup</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Style</label>
                        <select class="form-select" id="ai-style">
                            <option value="modern">Modern & Clean</option>
                            <option value="bold">Bold & Impactful</option>
                            <option value="minimal">Minimal</option>
                            <option value="luxury">Luxury</option>
                        </select>
                    </div>
                </div>
                <button type="button" class="btn btn-primary" onclick="generateAIPage()">
                    <i data-feather="zap"></i> Generate Page
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Preview Modal -->
<div class="modal fade" id="previewModal" tabindex="-1">
    <div class="modal-dialog modal-fullscreen">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Page Preview</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-0">
                <iframe id="previewFrame" style="width: 100%; height: 100%; border: none;"></iframe>
            </div>
        </div>
    </div>
</div>

<input type="hidden" name="csrf_token" id="csrf_token" value="{{ csrf_token() }}"/>
<input type="hidden" id="pageId" value="{{ page.id if page else '' }}"/>

<script>
const sectionTemplates = {
    'hero-centered': `
        <section class="py-5 text-center" style="background: linear-gradient(135deg, #301934 0%, #013220 100%); color: white; min-height: 500px; display: flex; align-items: center;">
            <div class="container">
                <h1 class="display-3 fw-bold mb-4">Your Amazing Headline</h1>
                <p class="lead mb-4 mx-auto" style="max-width: 600px;">A compelling subheadline that explains the value proposition and gets visitors excited about your offer.</p>
                <a href="#" class="btn btn-light btn-lg px-5 py-3">Get Started</a>
            </div>
        </section>`,
    'hero-split': `
        <section class="py-5" style="background: #f8f9fa;">
            <div class="container">
                <div class="row align-items-center">
                    <div class="col-lg-6">
                        <h1 class="display-4 fw-bold mb-4" style="color: #301934;">Transform Your Business Today</h1>
                        <p class="lead mb-4">Discover how our solution can help you achieve your goals faster and more efficiently.</p>
                        <a href="#" class="btn btn-lg px-4" style="background: #301934; color: white;">Learn More</a>
                    </div>
                    <div class="col-lg-6">
                        <div class="bg-secondary rounded" style="height: 400px; display: flex; align-items: center; justify-content: center; color: white;">Image Placeholder</div>
                    </div>
                </div>
            </div>
        </section>`,
    'hero-video': `
        <section class="py-5 text-center position-relative" style="background: #000; color: white; min-height: 500px;">
            <div class="container position-relative" style="z-index: 2;">
                <h1 class="display-4 fw-bold mb-4">Watch How It Works</h1>
                <p class="lead mb-4">See our product in action</p>
                <button class="btn btn-outline-light btn-lg"><i data-feather="play-circle"></i> Play Video</button>
            </div>
        </section>`,
    'navbar': `
        <nav class="navbar navbar-expand-lg navbar-dark" style="background: #301934;">
            <div class="container">
                <a class="navbar-brand fw-bold" href="#">Your Brand</a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarNav">
                    <ul class="navbar-nav ms-auto">
                        <li class="nav-item"><a class="nav-link" href="#">Home</a></li>
                        <li class="nav-item"><a class="nav-link" href="#">Features</a></li>
                        <li class="nav-item"><a class="nav-link" href="#">Pricing</a></li>
                        <li class="nav-item"><a class="nav-link" href="#">Contact</a></li>
                    </ul>
                </div>
            </div>
        </nav>`,
    'features-grid': `
        <section class="py-5">
            <div class="container">
                <h2 class="text-center mb-5" style="color: #301934;">Why Choose Us</h2>
                <div class="row g-4">
                    <div class="col-md-4">
                        <div class="text-center p-4">
                            <div class="rounded-circle bg-light d-inline-flex align-items-center justify-content-center mb-3" style="width: 80px; height: 80px;"><i data-feather="zap" style="color: #301934;"></i></div>
                            <h5>Fast Performance</h5>
                            <p class="text-muted">Lightning-fast results that exceed expectations.</p>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="text-center p-4">
                            <div class="rounded-circle bg-light d-inline-flex align-items-center justify-content-center mb-3" style="width: 80px; height: 80px;"><i data-feather="shield" style="color: #301934;"></i></div>
                            <h5>Secure & Reliable</h5>
                            <p class="text-muted">Enterprise-grade security you can trust.</p>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="text-center p-4">
                            <div class="rounded-circle bg-light d-inline-flex align-items-center justify-content-center mb-3" style="width: 80px; height: 80px;"><i data-feather="headphones" style="color: #301934;"></i></div>
                            <h5>24/7 Support</h5>
                            <p class="text-muted">Our team is here to help anytime.</p>
                        </div>
                    </div>
                </div>
            </div>
        </section>`,
    'features-list': `
        <section class="py-5" style="background: #f8f9fa;">
            <div class="container">
                <div class="row align-items-center">
                    <div class="col-lg-6">
                        <h2 class="mb-4" style="color: #301934;">Powerful Features</h2>
                        <div class="d-flex mb-3">
                            <i data-feather="check-circle" class="text-success me-3 flex-shrink-0"></i>
                            <div><h6>Feature One</h6><p class="text-muted mb-0">Description of this amazing feature.</p></div>
                        </div>
                        <div class="d-flex mb-3">
                            <i data-feather="check-circle" class="text-success me-3 flex-shrink-0"></i>
                            <div><h6>Feature Two</h6><p class="text-muted mb-0">Description of another great feature.</p></div>
                        </div>
                        <div class="d-flex mb-3">
                            <i data-feather="check-circle" class="text-success me-3 flex-shrink-0"></i>
                            <div><h6>Feature Three</h6><p class="text-muted mb-0">And one more feature to highlight.</p></div>
                        </div>
                    </div>
                    <div class="col-lg-6">
                        <div class="bg-secondary rounded" style="height: 350px; display: flex; align-items: center; justify-content: center; color: white;">Image</div>
                    </div>
                </div>
            </div>
        </section>`,
    'text-block': `
        <section class="py-5">
            <div class="container">
                <div class="row justify-content-center">
                    <div class="col-lg-8 text-center">
                        <h2 class="mb-4" style="color: #301934;">About Our Company</h2>
                        <p class="lead">Lorem ipsum dolor sit amet, consectetur adipiscing elit. Sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation.</p>
                    </div>
                </div>
            </div>
        </section>`,
    'image-text': `
        <section class="py-5">
            <div class="container">
                <div class="row align-items-center">
                    <div class="col-lg-6 mb-4 mb-lg-0">
                        <div class="bg-secondary rounded" style="height: 350px; display: flex; align-items: center; justify-content: center; color: white;">Image</div>
                    </div>
                    <div class="col-lg-6">
                        <h2 class="mb-4" style="color: #301934;">Section Heading</h2>
                        <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit. Sed do eiusmod tempor incididunt ut labore et dolore magna aliqua.</p>
                        <a href="#" class="btn" style="background: #301934; color: white;">Learn More</a>
                    </div>
                </div>
            </div>
        </section>`,
    'testimonials': `
        <section class="py-5" style="background: #f8f9fa;">
            <div class="container">
                <h2 class="text-center mb-5" style="color: #301934;">What Our Customers Say</h2>
                <div class="row g-4">
                    <div class="col-md-4">
                        <div class="card h-100 shadow-sm">
                            <div class="card-body">
                                <div class="text-warning mb-2">★★★★★</div>
                                <p>"Amazing product! Exceeded all my expectations."</p>
                                <div class="d-flex align-items-center mt-3">
                                    <div class="rounded-circle bg-primary text-white d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;">JD</div>
                                    <div class="ms-2"><strong>John Doe</strong><br><small class="text-muted">CEO, Company</small></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card h-100 shadow-sm">
                            <div class="card-body">
                                <div class="text-warning mb-2">★★★★★</div>
                                <p>"Best purchase I've made this year. Highly recommend!"</p>
                                <div class="d-flex align-items-center mt-3">
                                    <div class="rounded-circle bg-success text-white d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;">JS</div>
                                    <div class="ms-2"><strong>Jane Smith</strong><br><small class="text-muted">Designer</small></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card h-100 shadow-sm">
                            <div class="card-body">
                                <div class="text-warning mb-2">★★★★★</div>
                                <p>"Incredible service and support. Will order again!"</p>
                                <div class="d-flex align-items-center mt-3">
                                    <div class="rounded-circle bg-info text-white d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;">MJ</div>
                                    <div class="ms-2"><strong>Mike Johnson</strong><br><small class="text-muted">Developer</small></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>`,
    'logos': `
        <section class="py-5">
            <div class="container">
                <p class="text-center text-muted mb-4">Trusted by leading companies</p>
                <div class="row justify-content-center align-items-center g-4">
                    <div class="col-6 col-md-2 text-center"><div class="bg-light rounded p-3">Logo 1</div></div>
                    <div class="col-6 col-md-2 text-center"><div class="bg-light rounded p-3">Logo 2</div></div>
                    <div class="col-6 col-md-2 text-center"><div class="bg-light rounded p-3">Logo 3</div></div>
                    <div class="col-6 col-md-2 text-center"><div class="bg-light rounded p-3">Logo 4</div></div>
                    <div class="col-6 col-md-2 text-center"><div class="bg-light rounded p-3">Logo 5</div></div>
                </div>
            </div>
        </section>`,
    'stats': `
        <section class="py-5" style="background: #301934; color: white;">
            <div class="container">
                <div class="row text-center g-4">
                    <div class="col-md-3">
                        <h2 class="display-4 fw-bold">10K+</h2>
                        <p>Happy Customers</p>
                    </div>
                    <div class="col-md-3">
                        <h2 class="display-4 fw-bold">99%</h2>
                        <p>Satisfaction Rate</p>
                    </div>
                    <div class="col-md-3">
                        <h2 class="display-4 fw-bold">50+</h2>
                        <p>Countries</p>
                    </div>
                    <div class="col-md-3">
                        <h2 class="display-4 fw-bold">24/7</h2>
                        <p>Support</p>
                    </div>
                </div>
            </div>
        </section>`,
    'reviews': `
        <section class="py-5">
            <div class="container">
                <h2 class="text-center mb-2" style="color: #301934;">Customer Reviews</h2>
                <div class="text-center text-warning mb-4">★★★★★ <span class="text-muted">4.9 out of 5</span></div>
                <div class="row justify-content-center">
                    <div class="col-lg-8">
                        <div class="card shadow-sm">
                            <div class="card-body p-4">
                                <div class="text-warning mb-2">★★★★★</div>
                                <p class="lead">"This is the best product I've ever used. The quality is outstanding and the customer service is top-notch. Highly recommended!"</p>
                                <strong>— Sarah Johnson, Verified Buyer</strong>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>`,
    'cta-banner': `
        <section class="py-5 text-center" style="background: linear-gradient(135deg, #301934 0%, #013220 100%); color: white;">
            <div class="container">
                <h2 class="mb-3">Ready to Get Started?</h2>
                <p class="lead mb-4">Join thousands of satisfied customers today.</p>
                <a href="#" class="btn btn-light btn-lg px-5">Start Free Trial</a>
            </div>
        </section>`,
    'lead-form': `
        <section class="py-5" style="background: #f8f9fa;">
            <div class="container">
                <div class="row justify-content-center">
                    <div class="col-lg-6">
                        <div class="card shadow">
                            <div class="card-body p-4">
                                <h3 class="text-center mb-4" style="color: #301934;">Get In Touch</h3>
                                <form>
                                    <div class="mb-3">
                                        <input type="text" class="form-control form-control-lg" placeholder="Your Name">
                                    </div>
                                    <div class="mb-3">
                                        <input type="email" class="form-control form-control-lg" placeholder="Email Address">
                                    </div>
                                    <div class="mb-3">
                                        <textarea class="form-control" rows="3" placeholder="Your Message"></textarea>
                                    </div>
                                    <button type="submit" class="btn btn-lg w-100" style="background: #301934; color: white;">Submit</button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>`,
    'pricing': `
        <section class="py-5">
            <div class="container">
                <h2 class="text-center mb-5" style="color: #301934;">Pricing Plans</h2>
                <div class="row g-4 justify-content-center">
                    <div class="col-md-4">
                        <div class="card h-100 text-center">
                            <div class="card-body p-4">
                                <h5>Starter</h5>
                                <h2 class="my-4">$19<small class="text-muted">/mo</small></h2>
                                <ul class="list-unstyled mb-4">
                                    <li class="mb-2">5 Projects</li>
                                    <li class="mb-2">10GB Storage</li>
                                    <li class="mb-2">Email Support</li>
                                </ul>
                                <a href="#" class="btn btn-outline-primary w-100">Choose Plan</a>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card h-100 text-center border-primary" style="border-width: 2px;">
                            <div class="card-body p-4">
                                <span class="badge bg-primary mb-2">Popular</span>
                                <h5>Professional</h5>
                                <h2 class="my-4">$49<small class="text-muted">/mo</small></h2>
                                <ul class="list-unstyled mb-4">
                                    <li class="mb-2">Unlimited Projects</li>
                                    <li class="mb-2">100GB Storage</li>
                                    <li class="mb-2">Priority Support</li>
                                </ul>
                                <a href="#" class="btn btn-primary w-100">Choose Plan</a>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card h-100 text-center">
                            <div class="card-body p-4">
                                <h5>Enterprise</h5>
                                <h2 class="my-4">$99<small class="text-muted">/mo</small></h2>
                                <ul class="list-unstyled mb-4">
                                    <li class="mb-2">Everything in Pro</li>
                                    <li class="mb-2">Unlimited Storage</li>
                                    <li class="mb-2">Dedicated Support</li>
                                </ul>
                                <a href="#" class="btn btn-outline-primary w-100">Contact Us</a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>`,
    'countdown': `
        <section class="py-5 text-center" style="background: #301934; color: white;">
            <div class="container">
                <span class="badge bg-danger mb-3">Limited Time Offer</span>
                <h2 class="mb-4">Sale Ends In</h2>
                <div class="d-flex justify-content-center gap-3 mb-4">
                    <div class="bg-white text-dark rounded p-3" style="min-width: 80px;"><h3 class="mb-0">00</h3><small>Days</small></div>
                    <div class="bg-white text-dark rounded p-3" style="min-width: 80px;"><h3 class="mb-0">00</h3><small>Hours</small></div>
                    <div class="bg-white text-dark rounded p-3" style="min-width: 80px;"><h3 class="mb-0">00</h3><small>Mins</small></div>
                    <div class="bg-white text-dark rounded p-3" style="min-width: 80px;"><h3 class="mb-0">00</h3><small>Secs</small></div>
                </div>
                <a href="#" class="btn btn-light btn-lg">Shop Now</a>
            </div>
        </section>`,
    'product-grid': `
        <section class="py-5">
            <div class="container">
                <h2 class="text-center mb-5" style="color: #301934;">Our Products</h2>
                <div class="row g-4">
                    <div class="col-md-4">
                        <div class="card h-100 shadow-sm">
                            <div class="bg-light" style="height: 200px; display: flex; align-items: center; justify-content: center;">Product Image</div>
                            <div class="card-body text-center">
                                <h5>Product Name</h5>
                                <p class="text-muted">Short description</p>
                                <h4 style="color: #013220;">$49.99</h4>
                                <a href="#" class="btn btn-outline-primary">Add to Cart</a>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card h-100 shadow-sm">
                            <div class="bg-light" style="height: 200px; display: flex; align-items: center; justify-content: center;">Product Image</div>
                            <div class="card-body text-center">
                                <h5>Product Name</h5>
                                <p class="text-muted">Short description</p>
                                <h4 style="color: #013220;">$59.99</h4>
                                <a href="#" class="btn btn-outline-primary">Add to Cart</a>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card h-100 shadow-sm">
                            <div class="bg-light" style="height: 200px; display: flex; align-items: center; justify-content: center;">Product Image</div>
                            <div class="card-body text-center">
                                <h5>Product Name</h5>
                                <p class="text-muted">Short description</p>
                                <h4 style="color: #013220;">$69.99</h4>
                                <a href="#" class="btn btn-outline-primary">Add to Cart</a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>`,
    'gallery': `
        <section class="py-5">
            <div class="container">
                <h2 class="text-center mb-5" style="color: #301934;">Gallery</h2>
                <div class="row g-3">
                    <div class="col-md-4"><div class="bg-secondary rounded" style="height: 200px;"></div></div>
                    <div class="col-md-4"><div class="bg-secondary rounded" style="height: 200px;"></div></div>
                    <div class="col-md-4"><div class="bg-secondary rounded" style="height: 200px;"></div></div>
                    <div class="col-md-6"><div class="bg-secondary rounded" style="height: 200px;"></div></div>
                    <div class="col-md-6"><div class="bg-secondary rounded" style="height: 200px;"></div></div>
                </div>
            </div>
        </section>`,
    'video-embed': `
        <section class="py-5" style="background: #000;">
            <div class="container">
                <div class="ratio ratio-16x9">
                    <div class="bg-dark d-flex align-items-center justify-content-center text-white">
                        <div class="text-center">
                            <i data-feather="play-circle" style="width: 64px; height: 64px;"></i>
                            <p class="mt-2">Video Embed</p>
                        </div>
                    </div>
                </div>
            </div>
        </section>`,
    'faq': `
        <section class="py-5">
            <div class="container">
                <h2 class="text-center mb-5" style="color: #301934;">Frequently Asked Questions</h2>
                <div class="row justify-content-center">
                    <div class="col-lg-8">
                        <div class="accordion" id="faqAccordion">
                            <div class="accordion-item">
                                <h2 class="accordion-header"><button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#faq1">How does it work?</button></h2>
                                <div id="faq1" class="accordion-collapse collapse show" data-bs-parent="#faqAccordion">
                                    <div class="accordion-body">Lorem ipsum dolor sit amet, consectetur adipiscing elit. Sed do eiusmod tempor incididunt ut labore.</div>
                                </div>
                            </div>
                            <div class="accordion-item">
                                <h2 class="accordion-header"><button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#faq2">What's included?</button></h2>
                                <div id="faq2" class="accordion-collapse collapse" data-bs-parent="#faqAccordion">
                                    <div class="accordion-body">Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo.</div>
                                </div>
                            </div>
                            <div class="accordion-item">
                                <h2 class="accordion-header"><button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#faq3">Do you offer refunds?</button></h2>
                                <div id="faq3" class="accordion-collapse collapse" data-bs-parent="#faqAccordion">
                                    <div class="accordion-body">Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla.</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>`,
    'contact': `
        <section class="py-5" style="background: #f8f9fa;">
            <div class="container">
                <div class="row g-4">
                    <div class="col-md-4 text-center">
                        <i data-feather="map-pin" style="color: #301934;"></i>
                        <h5 class="mt-3">Address</h5>
                        <p class="text-muted">123 Business Street<br>City, State 12345</p>
                    </div>
                    <div class="col-md-4 text-center">
                        <i data-feather="phone" style="color: #301934;"></i>
                        <h5 class="mt-3">Phone</h5>
                        <p class="text-muted">(555) 123-4567</p>
                    </div>
                    <div class="col-md-4 text-center">
                        <i data-feather="mail" style="color: #301934;"></i>
                        <h5 class="mt-3">Email</h5>
                        <p class="text-muted">hello@example.com</p>
                    </div>
                </div>
            </div>
        </section>`,
    'map': `
        <section style="height: 400px; background: #ddd; display: flex; align-items: center; justify-content: center;">
            <div class="text-center text-muted">
                <i data-feather="map-pin" style="width: 48px; height: 48px;"></i>
                <p class="mt-2">Map Embed (Replace with Google Maps iframe)</p>
            </div>
        </section>`,
    'spacer': `<div class="py-5"></div>`,
    'divider': `
        <div class="container py-4">
            <hr style="border-color: #ddd;">
        </div>`,
    'footer': `
        <footer class="py-5" style="background: #1a1a1a; color: white;">
            <div class="container">
                <div class="row g-4">
                    <div class="col-md-4">
                        <h5>Your Brand</h5>
                        <p class="text-muted">Building amazing products for amazing people.</p>
                    </div>
                    <div class="col-md-2">
                        <h6>Links</h6>
                        <ul class="list-unstyled">
                            <li><a href="#" class="text-muted">Home</a></li>
                            <li><a href="#" class="text-muted">About</a></li>
                            <li><a href="#" class="text-muted">Contact</a></li>
                        </ul>
                    </div>
                    <div class="col-md-2">
                        <h6>Legal</h6>
                        <ul class="list-unstyled">
                            <li><a href="#" class="text-muted">Privacy</a></li>
                            <li><a href="#" class="text-muted">Terms</a></li>
                        </ul>
                    </div>
                    <div class="col-md-4">
                        <h6>Newsletter</h6>
                        <form class="d-flex gap-2">
                            <input type="email" class="form-control" placeholder="Email">
                            <button class="btn btn-primary">Subscribe</button>
                        </form>
                    </div>
                </div>
                <hr class="my-4" style="border-color: #333;">
                <p class="text-center text-muted mb-0">&copy; 2025 Your Brand. All rights reserved.</p>
            </div>
        </footer>`,
    'html-block': `
        <section class="py-4">
            <div class="container">
                <div class="bg-light p-4 rounded text-center">
                    <p class="text-muted mb-0">Custom HTML Block - Edit to add your own code</p>
                </div>
            </div>
        </section>`
};

let pageSchema = [];
let selectedSection = null;
let sectionCounter = 0;

document.addEventListener('DOMContentLoaded', function() {
    initDragDrop();
    feather.replace();
    
    // Load existing page data if editing
    {% if page and page.builder_schema %}
    try {
        const savedSchema = {{ page.builder_schema|safe }};
        if (savedSchema && savedSchema.length > 0) {
            pageSchema = savedSchema;
            sectionCounter = savedSchema.length;
            renderCanvas();
        }
    } catch(e) {
        console.log('No saved schema, starting fresh');
    }
    {% elif page and page.html_content %}
    // Fallback: load raw HTML as single section
    pageSchema = [{
        id: 'section-1',
        type: 'imported',
        html: {{ page.html_content|tojson|safe }}
    }];
    sectionCounter = 1;
    renderCanvas();
    {% endif %}
});

function initDragDrop() {
    const components = document.querySelectorAll('.component-item');
    const canvas = document.getElementById('pageCanvas');
    
    components.forEach(comp => {
        comp.addEventListener('dragstart', handleDragStart);
        comp.addEventListener('dragend', handleDragEnd);
    });
    
    canvas.addEventListener('dragover', handleDragOver);
    canvas.addEventListener('dragleave', handleDragLeave);
    canvas.addEventListener('drop', handleDrop);
}

function handleDragStart(e) {
    e.dataTransfer.setData('section-type', e.target.dataset.section);
    e.target.classList.add('dragging');
}

function handleDragEnd(e) {
    e.target.classList.remove('dragging');
}

function handleDragOver(e) {
    e.preventDefault();
    document.getElementById('pageCanvas').classList.add('drag-over');
}

function handleDragLeave(e) {
    document.getElementById('pageCanvas').classList.remove('drag-over');
}

function handleDrop(e) {
    e.preventDefault();
    document.getElementById('pageCanvas').classList.remove('drag-over');
    
    const sectionType = e.dataTransfer.getData('section-type');
    if (sectionType && sectionTemplates[sectionType]) {
        addSection(sectionType);
    }
}

function addSection(sectionType) {
    const template = sectionTemplates[sectionType];
    if (!template) return;
    
    const sectionId = 'section-' + (++sectionCounter);
    const sectionData = {
        id: sectionId,
        type: sectionType,
        html: template
    };
    
    pageSchema.push(sectionData);
    renderCanvas();
}

function renderCanvas() {
    const canvas = document.getElementById('pageCanvas');
    const emptyState = document.getElementById('emptyState');
    
    if (pageSchema.length === 0) {
        emptyState.style.display = 'block';
        return;
    }
    
    emptyState.style.display = 'none';
    
    let html = '';
    pageSchema.forEach((section, index) => {
        html += `
            <div class="section-block ${selectedSection === section.id ? 'selected' : ''}" 
                 data-section-id="${section.id}" 
                 data-index="${index}"
                 onclick="selectSection('${section.id}')"
                 draggable="true">
                <div class="section-controls">
                    <button class="btn-move" title="Move"><i data-feather="move"></i></button>
                    <button class="btn-edit" title="Edit" onclick="event.stopPropagation(); editSection('${section.id}')"><i data-feather="edit-2"></i></button>
                    <button class="btn-delete" title="Delete" onclick="event.stopPropagation(); deleteSection('${section.id}')"><i data-feather="trash-2"></i></button>
                </div>
                ${section.html}
            </div>
        `;
    });
    
    canvas.innerHTML = html;
    feather.replace();
    
    initSectionDragDrop();
}

function initSectionDragDrop() {
    const sections = document.querySelectorAll('.section-block');
    sections.forEach(section => {
        section.addEventListener('dragstart', handleSectionDragStart);
        section.addEventListener('dragover', handleSectionDragOver);
        section.addEventListener('drop', handleSectionDrop);
        section.addEventListener('dragend', handleSectionDragEnd);
    });
}

let draggedIndex = null;

function handleSectionDragStart(e) {
    draggedIndex = parseInt(e.target.dataset.index);
    e.target.style.opacity = '0.5';
}

function handleSectionDragOver(e) {
    e.preventDefault();
}

function handleSectionDrop(e) {
    e.preventDefault();
    const dropIndex = parseInt(e.target.closest('.section-block').dataset.index);
    if (draggedIndex !== null && draggedIndex !== dropIndex) {
        const [removed] = pageSchema.splice(draggedIndex, 1);
        pageSchema.splice(dropIndex, 0, removed);
        renderCanvas();
    }
}

function handleSectionDragEnd(e) {
    e.target.style.opacity = '1';
    draggedIndex = null;
}

function selectSection(sectionId) {
    selectedSection = sectionId;
    renderCanvas();
    showProperties(sectionId);
}

function showProperties(sectionId) {
    const section = pageSchema.find(s => s.id === sectionId);
    if (!section) return;
    
    const propsContent = document.getElementById('propertiesContent');
    propsContent.innerHTML = `
        <div class="property-group">
            <label>Section Type</label>
            <input type="text" value="${section.type}" readonly>
        </div>
        <div class="property-group">
            <label>Custom HTML</label>
            <textarea id="sectionHtml" rows="10">${section.html.replace(/</g, '&lt;').replace(/>/g, '&gt;')}</textarea>
        </div>
        <button class="btn btn-primary btn-sm w-100" onclick="updateSectionHtml('${sectionId}')">
            <i data-feather="check"></i> Apply Changes
        </button>
    `;
    feather.replace();
}

function updateSectionHtml(sectionId) {
    const section = pageSchema.find(s => s.id === sectionId);
    if (!section) return;
    
    const textarea = document.getElementById('sectionHtml');
    section.html = textarea.value.replace(/&lt;/g, '<').replace(/&gt;/g, '>');
    renderCanvas();
}

function editSection(sectionId) {
    selectSection(sectionId);
}

function deleteSection(sectionId) {
    if (confirm('Delete this section?')) {
        pageSchema = pageSchema.filter(s => s.id !== sectionId);
        selectedSection = null;
        document.getElementById('propertiesContent').innerHTML = '<p class="text-muted text-center mt-4">Select a section to edit</p>';
        renderCanvas();
    }
}

function toggleCategory(header) {
    const list = header.nextElementSibling;
    const icon = header.querySelector('i');
    if (list.style.display === 'none') {
        list.style.display = 'grid';
        icon.style.transform = 'rotate(0deg)';
    } else {
        list.style.display = 'none';
        icon.style.transform = 'rotate(-90deg)';
    }
}

function setViewport(device) {
    const wrapper = document.getElementById('canvasWrapper');
    const buttons = document.querySelectorAll('.device-toggle button');
    buttons.forEach(b => b.classList.remove('active'));
    event.target.closest('button').classList.add('active');
    
    switch(device) {
        case 'desktop':
            wrapper.style.maxWidth = '1200px';
            break;
        case 'tablet':
            wrapper.style.maxWidth = '768px';
            break;
        case 'mobile':
            wrapper.style.maxWidth = '375px';
            break;
    }
}

function previewPage() {
    const html = generateFullHTML();
    const blob = new Blob([html], { type: 'text/html' });
    const url = URL.createObjectURL(blob);
    document.getElementById('previewFrame').src = url;
    new bootstrap.Modal(document.getElementById('previewModal')).show();
}

function generateFullHTML() {
    let sectionsHtml = pageSchema.map(s => s.html).join('\n');
    return `<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>${document.getElementById('pageName').value || 'Landing Page'}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"><\/script>
</head>
<body>
${sectionsHtml}
<script>feather.replace();<\/script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"><\/script>
</body>
</html>`;
}

function saveLandingPage() {
    const name = document.getElementById('pageName').value.trim();
    const slug = document.getElementById('pageSlug').value.trim();
    const pageId = document.getElementById('pageId').value;
    
    if (!name) {
        alert('Please enter a page name');
        return;
    }
    if (!slug) {
        alert('Please enter a URL slug');
        return;
    }
    
    const htmlContent = pageSchema.map(s => s.html).join('\n');
    
    fetch('/api/landing-page/save', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.getElementById('csrf_token').value
        },
        body: JSON.stringify({
            id: pageId || null,
            name: name,
            slug: slug,
            html_content: htmlContent,
            builder_schema: pageSchema
        })
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            alert('Landing page saved!');
            if (data.page_id && !pageId) {
                document.getElementById('pageId').value = data.page_id;
            }
        } else {
            alert('Error: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(err => {
        console.error(err);
        alert('Failed to save page');
    });
}

function generateAIPage() {
    const prompt = document.getElementById('ai-prompt').value;
    const pageType = document.getElementById('ai-page-type').value;
    const style = document.getElementById('ai-style').value;
    
    if (!prompt.trim()) {
        alert('Please describe your landing page');
        return;
    }
    
    const btn = event.target;
    btn.disabled = true;
    btn.innerHTML = '<i data-feather="loader"></i> Generating...';
    
    fetch('/api/ai/generate-landing-page', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.getElementById('csrf_token').value
        },
        body: JSON.stringify({
            prompt: prompt,
            page_type: pageType,
            style: style
        })
    })
    .then(r => r.json())
    .then(data => {
        btn.disabled = false;
        btn.innerHTML = '<i data-feather="zap"></i> Generate Page';
        feather.replace();
        
        if (data.success && data.html_content) {
            pageSchema = [{
                id: 'section-' + (++sectionCounter),
                type: 'ai-generated',
                html: data.html_content
            }];
            renderCanvas();
            bootstrap.Modal.getInstance(document.getElementById('aiSuggestionsModal')).hide();
        } else {
            alert('Error generating page');
        }
    })
    .catch(err => {
        btn.disabled = false;
        btn.innerHTML = '<i data-feather="zap"></i> Generate Page';
        feather.replace();
        console.error(err);
    });
}

document.getElementById('pageName').addEventListener('input', function() {
    const slug = this.value.toLowerCase()
        .replace(/[^a-z0-9\s-]/g, '')
        .replace(/\s+/g, '-')
        .replace(/-+/g, '-');
    document.getElementById('pageSlug').value = slug;
});
</script>
{% endblock %}
