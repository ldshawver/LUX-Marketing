{% extends "base.html" %}

{% block title %}Newsletter Archive - LUX Marketing{% endblock %}

{% block content %}
<div class="container-fluid py-5" style="background: linear-gradient(135deg, #000000 0%, #301934 100%); min-height: 40vh;">
    <div class="container">
        <div class="row justify-content-center text-center text-white">
            <div class="col-lg-8">
                <h1 class="display-4 fw-bold mb-3">
                    <i data-feather="archive" class="text-warning me-3"></i>
                    Newsletter Archive
                </h1>
                <p class="lead">Browse our complete collection of newsletters and marketing insights.</p>
            </div>
        </div>
    </div>
</div>

<div class="container py-5">
    {% if newsletters %}
    <div class="row">
        {% for newsletter in newsletters %}
        <div class="col-lg-6 col-xl-4 mb-4">
            <div class="card h-100 shadow-sm">
                <div class="card-body d-flex flex-column">
                    <div class="mb-3">
                        <h5 class="card-title">{{ newsletter.title }}</h5>
                        <div class="d-flex justify-content-between align-items-center">
                            <small class="text-muted">
                                <i data-feather="calendar" style="width: 14px; height: 14px;"></i>
                                {{ newsletter.published_at.strftime('%B %d, %Y') }}
                            </small>
                            <span class="badge bg-primary">
                                <i data-feather="eye" style="width: 12px; height: 12px;"></i>
                                {{ newsletter.view_count }} views
                            </span>
                        </div>
                    </div>
                    
                    <!-- Newsletter Preview -->
                    {% if newsletter.html_content %}
                    <div class="newsletter-preview mb-3">
                        {{ newsletter.html_content|truncate(200)|safe }}
                    </div>
                    {% endif %}
                    
                    <div class="mt-auto">
                        <a href="{{ url_for('main.view_newsletter', slug=newsletter.slug) }}" 
                           class="btn btn-outline-primary w-100">
                            <i data-feather="book-open"></i> Read Newsletter
                        </a>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    
    <!-- Pagination could be added here -->
    {% if newsletters|length >= 12 %}
    <div class="row mt-5">
        <div class="col-12 text-center">
            <button class="btn btn-outline-primary" onclick="loadMore()">
                <i data-feather="chevron-down"></i> Load More Newsletters
            </button>
        </div>
    </div>
    {% endif %}
    
    {% else %}
    <!-- Empty State -->
    <div class="row">
        <div class="col-12">
            <div class="text-center py-5">
                <i data-feather="archive" class="text-muted" style="width: 4rem; height: 4rem;"></i>
                <h3 class="mt-4">No Newsletters Yet</h3>
                <p class="text-muted">Our newsletter archive is currently being built. Check back soon for marketing insights and updates!</p>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- Search & Subscriber Management Section -->
<div class="container-fluid py-5" style="background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-lg-10">
                <div class="row g-4">
                    <div class="col-md-6">
                        <div class="card bg-dark border-0 h-100" style="background: rgba(255,255,255,0.05) !important;">
                            <div class="card-body text-center p-4">
                                <i data-feather="search" class="text-info mb-3" style="width: 2.5rem; height: 2.5rem;"></i>
                                <h4 class="text-white mb-3">Search Archives</h4>
                                <p class="text-muted mb-4">Find newsletters by topic, date, or keyword.</p>
                                <form id="searchArchiveForm">
                                    <div class="input-group">
                                        <input type="text" class="form-control bg-dark text-white border-secondary" 
                                               id="archiveSearch" name="search" 
                                               placeholder="Search newsletters..." 
                                               style="background-color: rgba(0,0,0,0.3) !important;">
                                        <button type="submit" class="btn btn-info">
                                            <i data-feather="search"></i>
                                        </button>
                                    </div>
                                </form>
                                <div id="searchResults" class="mt-3 text-start" style="display: none;"></div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card bg-dark border-0 h-100" style="background: rgba(255,255,255,0.05) !important;">
                            <div class="card-body text-center p-4">
                                <i data-feather="user-plus" class="text-success mb-3" style="width: 2.5rem; height: 2.5rem;"></i>
                                <h4 class="text-white mb-3">Add Subscriber</h4>
                                <p class="text-muted mb-4">Add a new subscriber to the newsletter list.</p>
                                <form id="addSubscriberForm">
                                    <div class="row g-2 mb-3">
                                        <div class="col-6">
                                            <input type="text" class="form-control bg-dark text-white border-secondary" 
                                                   id="subFirstName" name="first_name" placeholder="First Name"
                                                   style="background-color: rgba(0,0,0,0.3) !important;">
                                        </div>
                                        <div class="col-6">
                                            <input type="text" class="form-control bg-dark text-white border-secondary" 
                                                   id="subLastName" name="last_name" placeholder="Last Name"
                                                   style="background-color: rgba(0,0,0,0.3) !important;">
                                        </div>
                                    </div>
                                    <div class="input-group">
                                        <input type="email" class="form-control bg-dark text-white border-secondary" 
                                               id="subEmail" name="email" placeholder="Email address" required
                                               style="background-color: rgba(0,0,0,0.3) !important;">
                                        <button type="submit" class="btn btn-success" id="addSubBtn">
                                            <i data-feather="plus"></i> Add
                                        </button>
                                    </div>
                                </form>
                                <div id="addSubMessage" class="mt-3" style="display: none;"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<style>
.newsletter-preview {
    max-height: 120px;
    overflow: hidden;
    position: relative;
}

.newsletter-preview::after {
    content: '';
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    height: 30px;
    background: linear-gradient(transparent, white);
}

.card:hover {
    transform: translateY(-2px);
    transition: transform 0.2s ease-in-out;
}
</style>

<script>
function loadMore() {
    alert('Load more functionality would be implemented here');
}

document.getElementById('searchArchiveForm').addEventListener('submit', function(e) {
    e.preventDefault();
    const query = document.getElementById('archiveSearch').value.trim();
    const resultsDiv = document.getElementById('searchResults');
    
    if (!query) {
        resultsDiv.style.display = 'none';
        return;
    }
    
    resultsDiv.style.display = 'block';
    resultsDiv.innerHTML = '<div class="text-center"><span class="spinner-border spinner-border-sm text-info"></span> Searching...</div>';
    
    fetch('/api/newsletters/search?q=' + encodeURIComponent(query))
    .then(response => response.json())
    .then(data => {
        if (data.success && data.newsletters && data.newsletters.length > 0) {
            let html = '<div class="list-group list-group-flush">';
            data.newsletters.forEach(n => {
                html += `<a href="/newsletter/${n.slug}" class="list-group-item list-group-item-action bg-transparent text-white border-secondary">
                    <div class="d-flex justify-content-between align-items-center">
                        <span>${n.title}</span>
                        <small class="text-muted">${n.published_at || ''}</small>
                    </div>
                </a>`;
            });
            html += '</div>';
            resultsDiv.innerHTML = html;
        } else {
            resultsDiv.innerHTML = '<p class="text-muted mb-0">No newsletters found matching "' + query + '"</p>';
        }
    })
    .catch(error => {
        resultsDiv.innerHTML = '<p class="text-danger mb-0">Search failed. Please try again.</p>';
    });
});

document.getElementById('addSubscriberForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const firstName = document.getElementById('subFirstName').value;
    const lastName = document.getElementById('subLastName').value;
    const email = document.getElementById('subEmail').value;
    const btn = document.getElementById('addSubBtn');
    const message = document.getElementById('addSubMessage');
    
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';
    
    fetch('/api/contacts/add-subscriber', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ 
            email: email,
            first_name: firstName,
            last_name: lastName
        })
    })
    .then(response => response.json())
    .then(data => {
        message.style.display = 'block';
        if (data.success) {
            message.className = 'alert alert-success mt-3 py-2';
            message.textContent = data.message || 'Subscriber added successfully!';
            document.getElementById('addSubscriberForm').reset();
        } else {
            message.className = 'alert alert-danger mt-3 py-2';
            message.textContent = data.error || 'Failed to add subscriber';
        }
        btn.disabled = false;
        btn.innerHTML = '<i data-feather="plus"></i> Add';
        feather.replace();
    })
    .catch(error => {
        message.style.display = 'block';
        message.className = 'alert alert-danger mt-3 py-2';
        message.textContent = 'An error occurred. Please try again.';
        btn.disabled = false;
        btn.innerHTML = '<i data-feather="plus"></i> Add';
        feather.replace();
    });
});
</script>
{% endblock %}