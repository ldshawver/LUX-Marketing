{% extends "base.html" %}
{% block title %}WordPress Integration - LUX Marketing{% endblock %}
{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1><i data-feather="globe"></i> WordPress Integration</h1>
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#connectModal"><i data-feather="plus"></i> Connect WordPress</button>
    </div>

    <!-- Connected Sites -->
    <div class="row">
        {% for integration in integrations %}
        <div class="col-md-6 mb-4">
            <div class="card">
                <div class="card-body">
                    <h5>{{ integration.site_url }}</h5>
                    <div class="mb-3">
                        <span class="badge bg-{{ 'success' if integration.is_active else 'secondary' }}">{{ 'Active' if integration.is_active else 'Inactive' }}</span>
                    </div>
                    
                    <div class="small mb-3">
                        <p><i data-feather="check-circle" class="text-success"></i> Sync Products: {{ 'Yes' if integration.sync_products else 'No' }}</p>
                        <p><i data-feather="check-circle" class="text-success"></i> Sync Posts: {{ 'Yes' if integration.sync_blog_posts else 'No' }}</p>
                    </div>
                    
                    <div class="d-flex gap-2">
                        <button class="btn btn-sm btn-success sync-btn" data-wp-id="{{ integration.id }}">
                            <i data-feather="refresh-cw"></i> Sync Now
                        </button>
                        <button class="btn btn-sm btn-outline-danger">Remove</button>
                    </div>
                    
                    <small class="text-muted d-block mt-2">Last synced: {{ integration.last_synced_at.strftime('%Y-%m-%d %H:%M') if integration.last_synced_at else 'Never' }}</small>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    {% if not integrations %}
    <div class="alert alert-info text-center">Connect your WordPress sites to sync products, blog posts, and marketing data directly.</div>
    {% endif %}
</div>

<!-- Connect Modal -->
<div class="modal fade" id="connectModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Connect WordPress Site</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="wpConnectForm">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">WordPress Site URL</label>
                        <input type="url" class="form-control" id="wpSiteUrl" placeholder="https://example.com" required>
                        <small class="text-muted">Your WordPress site URL (e.g., https://myblog.com)</small>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">API Key / Application Password</label>
                        <input type="password" class="form-control" id="wpApiKey" placeholder="Enter your WordPress API key" required>
                        <small class="text-muted">Generate an Application Password in WordPress Settings > Applications</small>
                    </div>
                    
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="syncProducts" checked>
                            <label class="form-check-label" for="syncProducts">
                                Sync Products (WooCommerce)
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="syncPosts" checked>
                            <label class="form-check-label" for="syncPosts">
                                Sync Blog Posts
                            </label>
                        </div>
                    </div>
                    
                    <div id="wpConnectStatus"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary" id="connectBtn">
                        <span id="connectBtnText">Test & Connect</span>
                        <span id="connectSpinner" class="spinner-border spinner-border-sm ms-2" style="display:none;"></span>
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
document.getElementById('wpConnectForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const siteUrl = document.getElementById('wpSiteUrl').value;
    const apiKey = document.getElementById('wpApiKey').value;
    const syncProducts = document.getElementById('syncProducts').checked;
    const syncPosts = document.getElementById('syncPosts').checked;
    const status = document.getElementById('wpConnectStatus');
    const btn = document.getElementById('connectBtn');
    const spinner = document.getElementById('connectSpinner');
    const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
    
    btn.disabled = true;
    spinner.style.display = 'inline-block';
    status.innerHTML = '<div class="alert alert-info">Testing connection...</div>';
    
    fetch('{{ url_for("main.connect_wordpress") }}', {
        method: 'POST',
        headers: { 
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify({
            site_url: siteUrl,
            api_key: apiKey,
            sync_products: syncProducts,
            sync_blog_posts: syncPosts
        })
    })
    .then(r => r.json())
    .then(d => {
        btn.disabled = false;
        spinner.style.display = 'none';
        
        if (d.success) {
            status.innerHTML = '<div class="alert alert-success">✓ Connected successfully!</div>';
            setTimeout(() => {
                location.reload();
            }, 1500);
        } else {
            status.innerHTML = `<div class="alert alert-danger">✗ ${d.error}</div>`;
        }
    })
    .catch(e => {
        btn.disabled = false;
        spinner.style.display = 'none';
        status.innerHTML = `<div class="alert alert-danger">✗ Connection error: ${e.message}</div>`;
    });
});

// Sync button
document.querySelectorAll('.sync-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        const wpId = this.dataset.wpId;
        const originalText = this.innerHTML;
        const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
        this.disabled = true;
        this.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Syncing...';
        
        fetch(`{{ url_for("main.sync_wordpress_data", wordpress_id=0) }}`.replace('/0', `/${wpId}`), {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken
            }
        })
        .then(r => r.json())
        .then(d => {
            if (d.success) {
                alert(`✓ Synced! ${d.posts_synced} posts, ${d.products_synced} products`);
            } else {
                alert(`✗ Sync failed: ${d.error}`);
            }
            this.disabled = false;
            this.innerHTML = originalText;
        });
    });
});
</script>
{% endblock %}
